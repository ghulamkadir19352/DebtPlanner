<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Dashboard</title>
    <style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --danger-color: #e74c3c;
    --success-color: #2ecc71;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --text-color: #333;
    --text-light: #6c757d;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: var(--light-bg);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 30px;
}

h1 {
    color: var(--secondary-color);
    font-size: 2rem;
}

.total-debt {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--danger-color);
}

.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.debt-card {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    min-height: 100px;
    cursor: pointer;
    user-select: none;
}

.debt-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.debt-card.dragging {
    opacity: 0.7;
    transform: rotate(5deg);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.debt-content {
    flex: 1;
    margin-right: 15px;
    min-width: 0;
}

.debt-logo {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.debt-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.debt-name.clickable {
    cursor: pointer;
    color: var(--primary-color);
    text-decoration: underline;
    transition: color 0.3s ease;
}

.debt-name.clickable:hover {
    color: #2980b9;
}

.debt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--danger-color);
    transition: color 0.3s ease;
}

.add-debt-btn {
    background-color: var(--success-color);
    color: white;
    border: none;
    padding: 15px 25px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 600;
    transition: background-color 0.3s ease;
    margin: 20px 0;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.add-debt-btn:hover {
    background-color: #27ae60;
}

.pay-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s ease;
    margin-top: 10px;
}

.pay-btn:hover {
    background-color: #2980b9;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-color);
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

input[type="text"],
input[type="password"],
input[type="number"],
input[type="date"],
input[type="color"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
}

.manual-amount {
    display: none;
    margin-top: 10px;
}

/* Notes and Info Icon Styles */
.debt-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-icon {
    color: var(--primary-color);
    cursor: pointer;
    font-size: 1rem;
    opacity: 0.7;
    transition: opacity 0.3s ease;
    background: none;
    border: none;
    padding: 4px;
}

.info-icon:hover {
    opacity: 1;
}

.notes-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 25px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 1001;
    max-width: 500px;
    width: 90%;
    max-height: 400px;
}

.notes-popup h3 {
    margin-bottom: 15px;
    color: var(--secondary-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notes-popup .notes-content {
    white-space: pre-wrap;
    line-height: 1.4;
    margin-bottom: 15px;
    min-height: 100px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    background-color: var(--light-bg);
}

.notes-popup-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

/* Textarea styling */
textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
}

.btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-secondary {
    background-color: var(--border-color);
    color: var(--text-color);
}

.debt-list {
    margin-top: 20px;
}

.debt-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.debt-item:last-child {
    border-bottom: none;
}

/* Debt display styles */
.debt-display {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
}

.debt-info {
    flex-grow: 1;
}

.debt-amount-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.amount-label {
    font-weight: 500;
}

.amount-input {
    width: 100px;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
}

.update-amount-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.update-amount-btn:hover {
    background-color: #2980b9;
}

.debt-meta {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}

.debt-source {
    font-size: 0.8rem;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    background-color: var(--primary-color);
}

.debt-url {
    font-size: 0.8rem;
    color: var(--text-light);
    padding: 2px 8px;
    background-color: #f8f9fa;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Remove number input spinners */
.amount-input,
.no-spinner,
input[type="number"] {
    -moz-appearance: textfield;
}

.amount-input::-webkit-outer-spin-button,
.amount-input::-webkit-inner-spin-button,
.no-spinner::-webkit-outer-spin-button,
.no-spinner::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Edit form styles */
.debt-edit-form {
    display: none;
    margin-top: 0;
    padding: 0;
    background-color: transparent;
    border-left: none;
}

.debt-edit-form.edit-form-expanded {
    display: block;
    width: 100%;
}

.edit-form-content {
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 2px solid var(--primary-color);
    box-shadow: var(--shadow);
}

.edit-form-content h4 {
    margin-bottom: 20px;
    color: var(--secondary-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}

.edit-auto-fields,
.edit-manual-amount {
    margin-top: 15px;
}

.cancel-edit-btn {
    background-color: #6c757d;
}

.cancel-edit-btn:hover {
    background-color: #5a6268;
}

/* Ensure form elements in edit mode use full width */
.edit-form-content .form-group {
    margin-bottom: 20px;
}

.edit-form-content label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.edit-form-content input[type="text"],
.edit-form-content input[type="password"],
.edit-form-content input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.edit-form-content .radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.edit-form-content .radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
}

.edit-form-content .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.refresh-info {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    font-size: 0.9rem;
    color: var(--text-light);
    display: none;
}

/* Icon button styles */
.icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.1rem;
    width: 32px;
    height: 32px;
}

.update-btn {
    color: var(--primary-color);
    background-color: rgba(52, 152, 219, 0.1);
}

.update-btn:hover {
    background-color: rgba(52, 152, 219, 0.2);
    transform: scale(1.1);
}

.edit-btn-icon {
    color: var(--success-color);
    background-color: rgba(46, 204, 113, 0.1);
}

.edit-btn-icon:hover {
    background-color: rgba(46, 204, 113, 0.2);
    transform: scale(1.1);
}

.delete-btn-icon {
    color: var(--danger-color);
    background-color: rgba(231, 76, 60, 0.1);
}

.delete-btn-icon:hover {
    background-color: rgba(231, 76, 60, 0.2);
    transform: scale(1.1);
}

/* Regular increment styles */
.regular-increment-section {
    margin-top: 15px;
    padding: 15px;
    background-color: var(--light-bg);
    border-radius: 6px;
    border-left: 4px solid var(--primary-color);
}

.increment-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    cursor: pointer;
}

.increment-toggle input[type="checkbox"] {
    width: 16px;
    height: 16px;
}

.increment-toggle label {
    margin-bottom: 0;
    font-weight: 600;
    color: var(--secondary-color);
    cursor: pointer;
}

.increment-fields {
    display: none;
    gap: 15px;
    flex-wrap: wrap;
}

.increment-fields.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.increment-field {
    flex: 1;
    min-width: 150px;
}

.increment-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 0.9rem;
}

.increment-amount-input,
.increment-frequency-select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 0.9rem;
}

.increment-preview {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: white;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    color: var(--text-color);
}

.increment-preview .next-increment {
    color: var(--primary-color);
    font-weight: 600;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Amount styling */
.debt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    transition: color 0.3s ease;
}

.debt-meta-info {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-light);
}

.increment-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background-color: rgba(46, 204, 113, 0.1);
    color: var(--success-color);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-top: 4px;
}

/* Improved Debt Actions Layout */
.debt-actions {
    display: flex;
    flex-direction: row;
    gap: 8px;
    min-width: auto;
    align-items: center;
}

.debt-amount-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    flex-wrap: wrap;
}

.amount-input {
    width: 120px;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.9rem;
}

.increment-field.full-width {
    flex: 0 0 100%;
}

.increment-date-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 0.9rem;
}

/* Export/Import Styles */
.export-import-section {
    margin-top: 30px;
    padding: 20px;
    background-color: var(--light-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.export-import-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.export-btn, .import-btn {
    background-color: var(--secondary-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s ease;
}

.export-btn:hover, .import-btn:hover {
    background-color: #1a252f;
}

.file-input {
    display: none;
}

/* Notification styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background-color: var(--success-color);
    color: white;
    border-radius: 5px;
    box-shadow: var(--shadow);
    z-index: 1002;
    transform: translateX(150%);
    transition: transform 0.3s ease;
}

.notification.show {
    transform: translateX(0);
}

.notification.error {
    background-color: var(--danger-color);
}

.notification.info {
    background-color: var(--primary-color);
}

/* Logs Section */
.logs-section {
    margin-top: 20px;
    padding: 15px;
    background-color: var(--light-bg);
    border-radius: 6px;
    border-left: 4px solid var(--secondary-color);
}

.logs-section h4 {
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.logs-list {
    max-height: 200px;
    overflow-y: auto;
}

.log-entry {
    padding: 8px;
    margin-bottom: 5px;
    background-color: white;
    border-radius: 4px;
    border-left: 3px solid var(--primary-color);
    font-size: 0.85rem;
}

.log-entry.payment {
    border-left-color: var(--success-color);
}

.log-entry.increment {
    border-left-color: var(--primary-color);
}

.log-entry.manual-update {
    border-left-color: var(--warning-color, #f39c12);
}

.log-timestamp {
    color: var(--text-light);
    font-size: 0.75rem;
    margin-top: 2px;
}

/* Pay Modal */
.pay-modal .modal-content {
    max-width: 400px;
}

.pay-amount-input {
    font-size: 1.2rem;
    font-weight: bold;
    text-align: center;
}

/* Drag and Drop */
.drag-handle {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: grab;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.drag-handle:hover {
    opacity: 1;
}

.debt-card.dragging .drag-handle {
    cursor: grabbing;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .container {
        padding: 10px;
    }
    
    header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .dashboard {
        grid-template-columns: 1fr;
    }
    
    .debt-display {
        flex-direction: column;
        gap: 15px;
    }
    
    .debt-actions {
        align-self: flex-end;
    }
    
    .modal-content {
        padding: 20px;
        width: 95%;
    }
    
    .radio-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .notes-popup {
        width: 95%;
        max-height: 80vh;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Debt Dashboard</h1>
            <div class="total-debt">Total: ¬£0.00</div>
        </header>
        
        <div class="dashboard" id="debtDashboard">
            <!-- Debt cards will be dynamically added here -->
        </div>

        <!-- Add Debt Button -->
        <button class="add-debt-btn" id="addDebtBtn">
            ‚ûï Add New Debt
        </button>

        <div class="refresh-info" id="refreshInfo" style="display: none;">
            Last refreshed: <span id="lastRefreshTime">Never</span><br>
            Next refresh: <span id="nextRefreshTime">Calculating...</span>
        </div>
        
        <!-- Add Debt Modal -->
        <div class="modal" id="addDebtModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Debt</h2>
                    <button class="close-btn" id="closeAddModal">&times;</button>
                </div>
                
                <form id="debtForm">
                    <div class="form-group">
                        <label for="debtName">Debt Name</label>
                        <input type="text" id="debtName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Data Source</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="autoSource" name="dataSource" value="auto" checked>
                                <label for="autoSource">Automated (Selenium)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="manualSource" name="dataSource" value="manual">
                                <label for="manualSource">Manual Entry</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="autoFields">
                        <div class="form-group">
                            <label for="loginUrl">Login URL</label>
                            <input type="text" id="loginUrl">
                        </div>
                        
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password">
                        </div>
                    </div>
                    
                    <div class="form-group manual-amount" id="manualFields">
                        <label for="amount">Amount (¬£)</label>
                        <input type="number" id="amount" step="0.01" class="no-spinner">
                    </div>

                    <div class="form-group">
                         <label for="directLink">Direct Link</label>
                         <input type="text" id="directLink" placeholder="https://...">
                            <small style="color: var(--text-light); font-size: 0.8rem;">
                             If provided, the debt card will be clickable and open this link
                            </small>
                    </div>

                    
                    <div class="form-group">
                          <label for="notes">Notes</label>
                            <textarea id="notes" rows="3" placeholder="Add any notes about this debt..."></textarea>
                     </div>

                    <div class="form-group">
                        <label for="cardColor">Card Color</label>
                         <input type="color" id="cardColor" value="#ffffff">
                    </div>

                    <div class="form-group">
                        <label for="titleColor">Title Color</label>
                        <input type="color" id="titleColor" value="#2c3e50">
                    </div>

                    <div class="form-group">
                        <label for="logoImage">Logo Image</label>
                        <input type="file" id="logoImage" accept="image/*">
                         <small style="color: var(--text-light); font-size: 0.8rem;">
                              Select a square image from your local machine
                         </small>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Debt</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Pay Modal -->
        <div class="modal pay-modal" id="payModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Make Payment</h2>
                    <button class="close-btn" id="closePayModal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="payAmount">Payment Amount (¬£)</label>
                    <input type="number" id="payAmount" class="pay-amount-input no-spinner" step="0.01" min="0.01">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelPayBtn">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmPayBtn">Confirm Payment</button>
                </div>
            </div>
        </div>

        <!-- Export/Import Section -->
        <div class="export-import-section">
            <h3>Data Management</h3>
            <p>Export your data to a JSON file for backup or transfer to another machine.</p>
            <div class="export-import-buttons">
                <button class="export-btn" id="exportBtn">Export to JSON</button>
                <button class="import-btn" id="importBtn">Import from JSON</button>
                <input type="file" id="importFile" class="file-input" accept=".json">
            </div>
            <small style="color: var(--text-light);">
                Exported file includes all debt data, logos (as base64), and settings.
            </small>
        </div>
    </div>

    <!-- Notes Popup -->
    <div class="notes-popup-overlay" id="notesOverlay"></div>
    <div class="notes-popup" id="notesPopup">
        <h3>
            <span id="notesTitle">Notes</span>
            <button class="icon-btn edit-notes-btn" id="editNotesBtn" title="Edit Notes">‚úèÔ∏è</button>
        </h3>
        <div class="notes-content" id="notesContent" contenteditable="false"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" id="closeNotes">Close</button>
            <button class="btn btn-primary" id="saveNotesBtn" style="display: none;">Save Notes</button>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // ====================
    // SUPABASE CONFIGURATION
    // ====================
    const SUPABASE_URL = 'https://mtgdssyesgdnvznaqwrw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10Z2Rzc3llc2dkbnZ6bmFxd3J3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MDQ5MDQsImV4cCI6MjA3NTA4MDkwNH0.vW668rmSlx8RCJDHzpvPF58x-yJwJTEiGoxidi0AAlk';
    
    // Initialize Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====================
    // EXISTING APP VARIABLES
    // ====================
    let debts = [];
    let logoFile = null;
    let autoRefreshInterval = null;
    let lastRefreshTime = null;
    let currentDebtId = null;
    let currentPayDebtId = null;
    let isEditingNotes = false;
    let dragStartIndex = null;

    // DOM Elements
    const debtDashboard = document.getElementById('debtDashboard');
    const addDebtBtn = document.getElementById('addDebtBtn');
    const addDebtModal = document.getElementById('addDebtModal');
    const closeAddModal = document.getElementById('closeAddModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const debtForm = document.getElementById('debtForm');
    const totalDebtElement = document.querySelector('.total-debt');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const refreshInfo = document.getElementById('refreshInfo');
    const lastRefreshTimeElement = document.getElementById('lastRefreshTime');
    const nextRefreshTimeElement = document.getElementById('nextRefreshTime');
    const notesPopup = document.getElementById('notesPopup');
    const notesOverlay = document.getElementById('notesOverlay');
    const notesTitle = document.getElementById('notesTitle');
    const notesContent = document.getElementById('notesContent');
    const closeNotes = document.getElementById('closeNotes');
    const editNotesBtn = document.getElementById('editNotesBtn');
    const saveNotesBtn = document.getElementById('saveNotesBtn');
    const notification = document.getElementById('notification');
    const payModal = document.getElementById('payModal');
    const closePayModal = document.getElementById('closePayModal');
    const cancelPayBtn = document.getElementById('cancelPayBtn');
    const confirmPayBtn = document.getElementById('confirmPayBtn');
    const payAmount = document.getElementById('payAmount');

    // ====================
    // SUPABASE FUNCTIONS
    // ====================

// Load data from Supabase (cloud) - UPDATED VERSION
async function loadDataFromSupabase() {
    try {
        console.log('üîç Loading data from Supabase...');
        const { data, error } = await supabase
            .from('debts')
            .select('*')
            .order('created_at', { ascending: false }); // Get newest first

        if (error) {
            console.error('‚ùå Supabase error:', error);
            showNotification('Cloud load failed: ' + error.message, 'error');
            return false;
        }
        
        console.log('üì¶ Raw data received from Supabase:', data);
        
        if (data && data.length > 0) {
            // Extract debt_data from each record and filter out any null/undefined
            debts = data
                .map(item => item.debt_data)
                .filter(debt => debt !== null && debt !== undefined);
                
            console.log('‚úÖ Successfully loaded', debts.length, 'debts from Supabase');
            return true;
        } else {
            console.log('‚ÑπÔ∏è No data found in Supabase');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Supabase load failed:', error);
        showNotification('Cloud connection failed: ' + error.message, 'error');
        return false;
    }
}


// Run this in browser console to test Supabase
async function testSave() {
    const testData = {
        id: 999,
        name: "Test Debt",
        amount: 100,
        source: "manual"
    };
    
    const { data, error } = await supabase
        .from('debts')
        .insert([{ data: testData, created_at: new Date().toISOString() }])
        .select();
    
    console.log('Test result:', { data, error });
}

testSave();



// Save data to Supabase (cloud) - WORKING VERSION
async function saveDataToSupabase() {
    try {
        console.log('üíæ Saving data to Supabase...', debts);
        
        if (debts.length === 0) {
            console.log('‚ÑπÔ∏è No debts to save');
            return true;
        }

        // First, get all existing record IDs
        const { data: existingRecords, error: fetchError } = await supabase
            .from('debts')
            .select('id')
            .order('id');

        if (fetchError) {
            console.error('‚ùå Failed to fetch existing records:', fetchError);
            // Continue with insert anyway
        } else if (existingRecords && existingRecords.length > 0) {
            console.log('üóëÔ∏è Deleting', existingRecords.length, 'existing records...');
            
            // Delete records one by one to avoid issues
            for (const record of existingRecords) {
                const { error: deleteError } = await supabase
                    .from('debts')
                    .delete()
                    .eq('id', record.id);
                
                if (deleteError) {
                    console.error('‚ùå Failed to delete record', record.id, ':', deleteError);
                }
            }
            console.log('‚úÖ Existing records deleted');
        } else {
            console.log('‚ÑπÔ∏è No existing records to delete');
        }

        // Prepare and insert new data
        const debtsToInsert = debts.map(debt => ({
            debt_data: debt,
            created_at: new Date().toISOString()
        }));

        console.log('üì§ Inserting', debtsToInsert.length, 'new records...');

        const { data: insertedData, error: insertError } = await supabase
            .from('debts')
            .insert(debtsToInsert)
            .select();

        if (insertError) {
            console.error('‚ùå Insert failed:', insertError);
            throw insertError;
        }

        console.log('‚úÖ Successfully saved', insertedData.length, 'debts to Supabase');
        showNotification('Data synced to cloud successfully!', 'success');
        return true;
    } catch (error) {
        console.error('‚ùå Supabase save failed:', error);
        showNotification('Cloud save failed: ' + error.message, 'error');
        return false;
    }
}

    // Real-time sync - listen for changes from other devices
    function setupRealtimeSubscription() {
        console.log('üîÑ Setting up real-time sync...');
        
        supabase
            .channel('debts-changes')
            .on('postgres_changes', 
                { 
                    event: '*',
                    schema: 'public', 
                    table: 'debts' 
                }, 
                async (payload) => {
                    console.log('üì° Change detected from another device:', payload);
                    
                    // Reload data from Supabase when changes are detected
                    await loadDataFromSupabase();
                    renderDebtCards();
                    updateTotalDebt();
                    showNotification('Data synced from cloud', 'info');
                }
            )
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') {
                    console.log('‚úÖ Real-time sync activated');
                }
            });
    }

    // ====================
    // MODIFIED CORE FUNCTIONS
    // ====================

    // Initialize dashboard with Supabase
    async function initDashboard() {
        showNotification('Loading dashboard data...', 'info');
        
        // Try to load from Supabase first
        const supabaseLoaded = await loadDataFromSupabase();
        
        if (supabaseLoaded) {
            showNotification('Data loaded from cloud successfully!', 'success');
        } else {
            // If Supabase fails, try localStorage
            const localStorageLoaded = loadDataFromLocalStorage();
            
            if (localStorageLoaded) {
                showNotification('Data loaded from local storage', 'info');
            } else {
                showNotification('No data found. Add your first debt!', 'info');
                debts = [];
            }
        }
        
        renderDebtCards();
        updateTotalDebt();
        processRegularIncrements();
        startAutoRefresh();
        initializeDragAndDrop();
        setupRealtimeSubscription();
    }

    // Enhanced save function - saves to both localStorage AND Supabase
    async function saveDebtsToLocalStorage() {
        try {
            // 1. Always save to localStorage as backup
            localStorage.setItem('debtDashboard', JSON.stringify(debts));
            
            // 2. Try to save to Supabase for cloud sync
            const cloudSaved = await saveDataToSupabase();
            
            if (cloudSaved) {
                console.log('‚úÖ Data saved to cloud and local storage');
            } else {
                console.log('‚ö†Ô∏è Data saved to local storage only (cloud save failed)');
            }
            
            return true;
        } catch (e) {
            console.error('Error saving data:', e);
            showNotification('Error saving data', 'error');
            return false;
        }
    }

    // Load from localStorage (fallback)
    function loadDataFromLocalStorage() {
        try {
            const saved = localStorage.getItem('debtDashboard');
            if (saved) {
                const parsedData = JSON.parse(saved);
                if (Array.isArray(parsedData) && parsedData.length > 0) {
                    debts = parsedData;
                    console.log('üìÅ Loaded from localStorage:', debts.length, 'debts');
                    return true;
                }
            }
        } catch (error) {
            console.error('Error loading from localStorage:', error);
        }
        return false;
    }

    // ====================
    // EXISTING APPLICATION FUNCTIONS
    // ====================

    // Save data to JSON file - EXPORT FUNCTION
    async function saveDataToJSON() {
        try {
            const data = {
                debts: debts,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'debts_export.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        } catch (error) {
            console.error('Export failed:', error);
            showNotification('Export failed: ' + error.message, 'error');
        }
    }

    // Import data from JSON file - IMPORT FUNCTION
    function importDataFromJSON(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if (data && Array.isArray(data.debts)) {
                    debts = data.debts;
                    saveDebtsToLocalStorage();
                    renderDebtCards();
                    updateTotalDebt();
                    showNotification('Data imported successfully!', 'success');
                } else {
                    showNotification('Invalid JSON file format - missing debts array', 'error');
                }
            } catch (error) {
                showNotification('Error reading JSON file: ' + error.message, 'error');
            }
        };
        reader.onerror = function() {
            showNotification('Error reading file', 'error');
        };
        reader.readAsText(file);
    }

    // Render debt cards
    function renderDebtCards() {
        debtDashboard.innerHTML = '';
        
        if (debts.length === 0) {
            debtDashboard.innerHTML = `
                <div style="text-align: center; grid-column: 1 / -1; padding: 60px 20px; color: var(--text-light);">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üí≥</div>
                    <h3 style="margin-bottom: 15px; color: var(--secondary-color);">No Debts Found</h3>
                    <p style="margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
                        No debt data was found in cloud or local storage.
                    </p>
                </div>
            `;
            return;
        }
        
        debts.forEach((debt, index) => {
            const debtCard = document.createElement('div');
            debtCard.className = 'debt-card';
            debtCard.setAttribute('data-id', debt.id);
            debtCard.setAttribute('draggable', 'true');
            
            let incrementInfo = '';
            if (debt.regularIncrement && debt.regularIncrement.enabled) {
                const nextIncrement = calculateNextIncrement(debt);
                incrementInfo = `
                    <div class="increment-indicator">
                        ‚ÜóÔ∏è +¬£${debt.regularIncrement.amount} ${debt.regularIncrement.frequency}
                        ${nextIncrement ? `¬∑ Next: ${nextIncrement}` : ''}
                    </div>
                `;
            }
            
            debtCard.innerHTML = `
                <div class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                <div class="debt-content">
                    <div class="debt-title">
                        <div class="debt-name ${debt.direct_link ? 'clickable' : ''}" style="color: ${debt.titleColor || 'var(--secondary-color)'}">
                            ${debt.name}
                        </div>
                        ${debt.notes ? `<button class="info-icon" data-id="${debt.id}" title="View Notes">‚ÑπÔ∏è</button>` : '<button class="info-icon" data-id="${debt.id}" title="Add Notes" style="opacity:0.3">‚ÑπÔ∏è</button>'}
                    </div>
                    <div class="debt-amount" style="color: ${debt.titleColor || 'var(--danger-color)'}">¬£${debt.amount.toFixed(2)}</div>
                    ${incrementInfo}
                </div>
                ${debt.logoImage ? `<img src="${debt.logoImage}" alt="${debt.name} logo" class="debt-logo">` : ''}
                <button class="pay-btn" data-id="${debt.id}">Pay</button>
            `;

            if (debt.cardColor && debt.cardColor !== '#ffffff') {
                debtCard.style.backgroundColor = debt.cardColor;
            }

            // Click to open settings
            debtCard.addEventListener('click', (e) => {
                if (!e.target.classList.contains('info-icon') && !e.target.classList.contains('pay-btn') && !e.target.classList.contains('drag-handle')) {
                    openDebtSettings(debt.id);
                }
            });

            // Pay button
            const payButton = debtCard.querySelector('.pay-btn');
            payButton.addEventListener('click', (e) => {
                e.stopPropagation();
                openPayModal(debt.id);
            });

            // Info icon for notes
            const infoIcon = debtCard.querySelector('.info-icon');
            infoIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                showNotesPopup(debt.id);
            });

            debtDashboard.appendChild(debtCard);
        });
        
        initializeDragAndDrop();
    }

    // Update total debt display
    function updateTotalDebt() {
        const total = debts.reduce((sum, debt) => sum + debt.amount, 0);
        totalDebtElement.textContent = `Total: ¬£${total.toFixed(2)}`;
        document.title = `Debt Dashboard - ¬£${total.toFixed(2)}`;
    }

    // Update debt amount
    function updateDebtAmount(id, newAmount) {
        const debt = debts.find(d => d.id === id);
        if (debt) {
            debt.amount = parseFloat(newAmount);
            saveDebtsToLocalStorage();
            renderDebtCards();
            updateTotalDebt();
            showNotification(`Updated ${debt.name} to ¬£${newAmount.toFixed(2)}`, 'success');
        }
    }

    // Open debt settings modal
    function openDebtSettings(debtId) {
        const debt = debts.find(d => d.id === debtId);
        if (!debt) return;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const hasIncrement = debt.regularIncrement && debt.regularIncrement.enabled;
        const incrementChecked = hasIncrement ? 'checked' : '';
        const startDate = debt.regularIncrement?.startDate || new Date().toISOString().split('T')[0];
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Edit ${debt.name}</h2>
                    <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                </div>
                <form class="edit-debt-form" data-id="${debt.id}">
                    <div class="form-group">
                        <label for="edit-name-${debt.id}">Debt Name</label>
                        <input type="text" id="edit-name-${debt.id}" value="${debt.name}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Data Source</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="edit-auto-${debt.id}" name="edit-dataSource-${debt.id}" value="auto" ${debt.source === 'auto' ? 'checked' : ''}>
                                <label for="edit-auto-${debt.id}">Automated (Selenium)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="edit-manual-${debt.id}" name="edit-dataSource-${debt.id}" value="manual" ${debt.source === 'manual' ? 'checked' : ''}>
                                <label for="edit-manual-${debt.id}">Manual Entry</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="edit-auto-fields" id="edit-auto-fields-${debt.id}" style="${debt.source === 'auto' ? '' : 'display: none;'}">
                        <div class="form-group">
                            <label for="edit-loginUrl-${debt.id}">Login URL</label>
                            <input type="text" id="edit-loginUrl-${debt.id}" value="${debt.login_url || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-username-${debt.id}">Username</label>
                            <input type="text" id="edit-username-${debt.id}" value="${debt.username || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label for="edit-password-${debt.id}">Password</label>
                            <input type="password" id="edit-password-${debt.id}" value="" placeholder="Enter new password">
                        </div>
                    </div>
                    
                    <div class="form-group edit-manual-amount" id="edit-manual-fields-${debt.id}" style="${debt.source === 'manual' ? '' : 'display: none;'}">
                        <label for="edit-amount-${debt.id}">Amount (¬£)</label>
                        <input type="number" id="edit-amount-${debt.id}" value="${debt.amount}" step="0.01" class="no-spinner">
                    </div>

                    <div class="form-group">
                        <label for="edit-directLink-${debt.id}">Direct Link</label>
                        <input type="text" id="edit-directLink-${debt.id}" value="${debt.direct_link || ''}" placeholder="https://...">
                    </div>

                    <div class="form-group">
                        <label for="edit-notes-${debt.id}">Notes</label>
                        <textarea id="edit-notes-${debt.id}" rows="3">${debt.notes || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="edit-cardColor-${debt.id}">Card Color</label>
                        <input type="color" id="edit-cardColor-${debt.id}" value="${debt.cardColor || '#ffffff'}">
                    </div>

                    <div class="form-group">
                        <label for="edit-titleColor-${debt.id}">Title Color</label>
                        <input type="color" id="edit-titleColor-${debt.id}" value="${debt.titleColor || '#2c3e50'}">
                    </div>

                    <div class="form-group">
                        <label for="edit-logoImage-${debt.id}">Logo Image</label>
                        <input type="file" id="edit-logoImage-${debt.id}" accept="image/*">
                        ${debt.logoImage ? '<small style="color: var(--success-color);">Current image loaded</small>' : ''}
                    </div>

                    <div class="regular-increment-section">
                        <div class="increment-toggle">
                            <input type="checkbox" id="edit-regularIncrement-${debt.id}" ${incrementChecked}>
                            <label for="edit-regularIncrement-${debt.id}">Enable Regular Amount Increment</label>
                        </div>
                        <div class="increment-fields ${hasIncrement ? 'active' : ''}" id="edit-increment-fields-${debt.id}">
                            <div class="increment-field">
                                <label for="edit-incrementAmount-${debt.id}">Increment Amount (¬£)</label>
                                <input type="number" id="edit-incrementAmount-${debt.id}" class="increment-amount-input" value="${hasIncrement ? debt.regularIncrement.amount : '0'}" step="0.01" min="0">
                            </div>
                            <div class="increment-field">
                                <label for="edit-incrementFrequency-${debt.id}">Frequency</label>
                                <select id="edit-incrementFrequency-${debt.id}" class="increment-frequency-select">
                                    <option value="weekly" ${hasIncrement && debt.regularIncrement.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                    <option value="fortnightly" ${hasIncrement && debt.regularIncrement.frequency === 'fortnightly' ? 'selected' : ''}>Fortnightly</option>
                                    <option value="triweekly" ${hasIncrement && debt.regularIncrement.frequency === 'triweekly' ? 'selected' : ''}>Tri-weekly</option>
                                    <option value="monthly" ${hasIncrement && debt.regularIncrement.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                </select>
                            </div>
                            <div class="increment-field full-width">
                                <label for="edit-incrementStartDate-${debt.id}">Start Date</label>
                                <input type="date" id="edit-incrementStartDate-${debt.id}" class="increment-date-input" value="${startDate}">
                            </div>
                        </div>
                    </div>

                    <!-- Logs Section -->
                    <div class="logs-section">
                        <h4>Payment Logs</h4>
                        <div class="logs-list" id="logs-${debt.id}">
                            ${debt.logs && debt.logs.length > 0 ? debt.logs.map(log => `
                                <div class="log-entry ${log.type}">
                                    <div>${log.description}</div>
                                    <div class="log-timestamp">${new Date(log.timestamp).toLocaleString()}</div>
                                </div>
                            `).join('') : '<div>No logs yet</div>'}
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-danger" onclick="deleteDebt(${debt.id}); this.closest('.modal').remove()">Delete</button>
                    </div>
                </form>
            </div>
        `;

        document.body.appendChild(modal);

        // Form submission
        const form = modal.querySelector('.edit-debt-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            saveDebtChanges(debt.id);
            modal.remove();
        });

        // Toggle data source
        modal.querySelectorAll(`input[name="edit-dataSource-${debt.id}"]`).forEach(radio => {
            radio.addEventListener('change', () => {
                const isAuto = document.getElementById(`edit-auto-${debt.id}`).checked;
                document.getElementById(`edit-auto-fields-${debt.id}`).style.display = isAuto ? 'block' : 'none';
                document.getElementById(`edit-manual-fields-${debt.id}`).style.display = isAuto ? 'none' : 'block';
            });
        });

        // Toggle increment fields
        const incrementCheckbox = document.getElementById(`edit-regularIncrement-${debt.id}`);
        incrementCheckbox.addEventListener('change', function() {
            const incrementFields = document.getElementById(`edit-increment-fields-${debt.id}`);
            if (this.checked) {
                incrementFields.classList.add('active');
            } else {
                incrementFields.classList.remove('active');
            }
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    }

    // Save debt changes
    function saveDebtChanges(id) {
        const debt = debts.find(d => d.id === id);
        if (!debt) return;
        
        const newName = document.getElementById(`edit-name-${id}`).value;
        const newDataSource = document.querySelector(`input[name="edit-dataSource-${id}"]:checked`).value;
        const newAmount = parseFloat(document.getElementById(`edit-amount-${id}`).value) || 0;
        const newNotes = document.getElementById(`edit-notes-${id}`).value;
        const newDirectLink = document.getElementById(`edit-directLink-${id}`).value;
        const logoFileInput = document.getElementById(`edit-logoImage-${id}`);
        const logoFile = logoFileInput.files[0];
        const regularIncrementEnabled = document.getElementById(`edit-regularIncrement-${id}`).checked;
        const incrementAmount = parseFloat(document.getElementById(`edit-incrementAmount-${id}`).value) || 0;
        const incrementFrequency = document.getElementById(`edit-incrementFrequency-${id}`).value;
        const incrementStartDate = document.getElementById(`edit-incrementStartDate-${id}`).value;
        
        if (newAmount < 0) {
            showNotification('Amount cannot be negative', 'error');
            return;
        }
        
        debt.name = newName;
        debt.source = newDataSource;
        
        // Add log for manual amount changes
        if (debt.amount !== newAmount) {
            if (!debt.logs) debt.logs = [];
            debt.logs.unshift({
                type: 'manual-update',
                description: `Amount updated from ¬£${debt.amount.toFixed(2)} to ¬£${newAmount.toFixed(2)}`,
                timestamp: new Date().toISOString(),
                previousAmount: debt.amount,
                newAmount: newAmount
            });
        }
        
        debt.amount = newAmount;
        debt.notes = newNotes;
        debt.direct_link = newDirectLink;
        debt.cardColor = document.getElementById(`edit-cardColor-${id}`).value;
        debt.titleColor = document.getElementById(`edit-titleColor-${id}`).value;
        
        debt.regularIncrement = {
            enabled: regularIncrementEnabled,
            amount: incrementAmount,
            frequency: incrementFrequency,
            startDate: incrementStartDate,
            lastIncrement: debt.regularIncrement?.lastIncrement || null
        };
        
        if (logoFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                debt.logoImage = e.target.result;
                completeSaveDebtChanges(debt, newDataSource, id);
            };
            reader.readAsDataURL(logoFile);
        } else {
            completeSaveDebtChanges(debt, newDataSource, id);
        }
    }

    function completeSaveDebtChanges(debt, newDataSource, id) {
        if (newDataSource === 'auto') {
            debt.login_url = document.getElementById(`edit-loginUrl-${id}`).value;
            debt.username = document.getElementById(`edit-username-${id}`).value;
            const newPassword = document.getElementById(`edit-password-${id}`).value;
            if (newPassword) {
                debt.password = newPassword;
            }
        } else {
            debt.login_url = '';
            debt.username = '';
            debt.password = '';
        }
        
        saveDebtsToLocalStorage();
        renderDebtCards();
        updateTotalDebt();
        showNotification(`Updated ${debt.name} successfully`, 'success');
    }

    // Open pay modal
    function openPayModal(debtId) {
        currentPayDebtId = debtId;
        const debt = debts.find(d => d.id === debtId);
        payAmount.value = '';
        payModal.style.display = 'flex';
    }

    // Process payment
    function processPayment() {
        const amount = parseFloat(payAmount.value);
        if (!amount || amount <= 0) {
            showNotification('Please enter a valid payment amount', 'error');
            return;
        }

        const debt = debts.find(d => d.id === currentPayDebtId);
        if (!debt) return;

        if (amount > debt.amount) {
            showNotification('Payment amount cannot exceed current debt', 'error');
            return;
        }

        // Update debt amount
        const oldAmount = debt.amount;
        debt.amount -= amount;

        // Add log entry
        if (!debt.logs) debt.logs = [];
        debt.logs.unshift({
            type: 'payment',
            description: `Payment of ¬£${amount.toFixed(2)} made. Balance decreased from ¬£${oldAmount.toFixed(2)} to ¬£${debt.amount.toFixed(2)}`,
            timestamp: new Date().toISOString(),
            amount: amount,
            previousAmount: oldAmount,
            newAmount: debt.amount
        });

        // Keep only last 50 logs
        if (debt.logs.length > 50) {
            debt.logs = debt.logs.slice(0, 50);
        }

        saveDebtsToLocalStorage();
        renderDebtCards();
        updateTotalDebt();
        payModal.style.display = 'none';
        showNotification(`Payment of ¬£${amount.toFixed(2)} processed for ${debt.name}`, 'success');
    }

    // Initialize drag and drop
    function initializeDragAndDrop() {
        const debtCards = document.querySelectorAll('.debt-card');
        
        debtCards.forEach(card => {
            card.addEventListener('dragstart', (e) => {
                dragStartIndex = Array.from(debtCards).indexOf(card);
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                updateDebtOrder();
            });

            card.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(debtCards, e.clientY);
                const dragging = document.querySelector('.dragging');
                if (afterElement == null) {
                    debtDashboard.appendChild(dragging);
                } else {
                    debtDashboard.insertBefore(dragging, afterElement);
                }
            });
        });
    }

    function getDragAfterElement(containers, y) {
        return Array.from(containers).reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Update debt order after drag and drop
    function updateDebtOrder() {
        const newOrder = Array.from(document.querySelectorAll('.debt-card')).map(card => 
            parseInt(card.getAttribute('data-id'))
        );
        
        debts.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));
        saveDebtsToLocalStorage();
    }

    // Show notes popup with edit functionality
    function showNotesPopup(debtId) {
        currentDebtId = debtId;
        const debt = debts.find(d => d.id === debtId);
        if (debt) {
            notesTitle.textContent = `Notes: ${debt.name}`;
            notesContent.textContent = debt.notes || '';
            notesContent.contentEditable = 'false';
            saveNotesBtn.style.display = 'none';
            notesPopup.style.display = 'block';
            notesOverlay.style.display = 'block';
            isEditingNotes = false;
        }
    }

    // Toggle notes editing
    function toggleNotesEditing() {
        isEditingNotes = !isEditingNotes;
        notesContent.contentEditable = isEditingNotes.toString();
        saveNotesBtn.style.display = isEditingNotes ? 'block' : 'none';
        
        if (isEditingNotes) {
            notesContent.focus();
        }
    }

    // Save notes
    function saveNotes() {
        const debt = debts.find(d => d.id === currentDebtId);
        if (debt) {
            debt.notes = notesContent.textContent;
            saveDebtsToLocalStorage();
            showNotification('Notes saved successfully', 'success');
            toggleNotesEditing();
            renderDebtCards();
        }
    }

    // Delete debt
    function deleteDebt(id) {
        const debt = debts.find(d => d.id === id);
        if (debt && confirm(`Are you sure you want to delete "${debt.name}"?`)) {
            debts = debts.filter(d => d.id !== id);
            saveDebtsToLocalStorage();
            renderDebtCards();
            updateTotalDebt();
            showNotification(`Deleted ${debt.name}`, 'success');
        }
    }

    // Toggle data source in add form
    function toggleDataSource() {
        if (document.getElementById('autoSource').checked) {
            document.getElementById('autoFields').style.display = 'block';
            document.getElementById('manualFields').style.display = 'none';
        } else {
            document.getElementById('autoFields').style.display = 'none';
            document.getElementById('manualFields').style.display = 'block';
        }
    }

    // Add new debt
    function addDebt(event) {
        event.preventDefault();
        
        const name = document.getElementById('debtName').value.trim();
        const source = document.querySelector('input[name="dataSource"]:checked').value;
        const amount = parseFloat(document.getElementById('amount').value) || 0;
        const notes = document.getElementById('notes').value.trim();
        const directLink = document.getElementById('directLink').value.trim();
        const cardColor = document.getElementById('cardColor').value;
        const titleColor = document.getElementById('titleColor').value;
        const logoInput = document.getElementById('logoImage');
        const logoFile = logoInput.files[0];
        
        if (!name) {
            showNotification('Debt name is required', 'error');
            return;
        }
        
        if (amount < 0) {
            showNotification('Amount cannot be negative', 'error');
            return;
        }
        
        const newDebt = {
            id: Date.now(),
            name,
            amount,
            source,
            notes,
            direct_link: directLink,
            cardColor,
            titleColor,
            logoImage: '',
            logs: [],
            regularIncrement: {
                enabled: false,
                amount: 0,
                frequency: 'weekly',
                startDate: new Date().toISOString().split('T')[0],
                lastIncrement: null
            }
        };
        
        if (source === 'auto') {
            newDebt.login_url = document.getElementById('loginUrl').value.trim();
            newDebt.username = document.getElementById('username').value.trim();
            newDebt.password = document.getElementById('password').value;
            
            if (!newDebt.login_url || !newDebt.username || !newDebt.password) {
                showNotification('Login URL, username and password are required for automated debts', 'error');
                return;
            }
        }
        
        if (logoFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                newDebt.logoImage = e.target.result;
                completeAddDebt(newDebt);
            };
            reader.readAsDataURL(logoFile);
        } else {
            completeAddDebt(newDebt);
        }
    }
    
    function completeAddDebt(newDebt) {
        debts.push(newDebt);
        saveDebtsToLocalStorage();
        renderDebtCards();
        updateTotalDebt();
        resetForm();
        addDebtModal.style.display = 'none';
        showNotification(`Added ${newDebt.name} successfully`, 'success');
    }

    // Reset form
    function resetForm() {
        debtForm.reset();
        document.getElementById('cardColor').value = '#ffffff';
        document.getElementById('titleColor').value = '#2c3e50';
        document.getElementById('autoFields').style.display = 'block';
        document.getElementById('manualFields').style.display = 'none';
    }

    // Calculate next increment date
    function calculateNextIncrement(debt) {
        if (!debt.regularIncrement || !debt.regularIncrement.enabled) return null;
        
        const startDate = new Date(debt.regularIncrement.startDate || debt.regularIncrement.lastIncrement || new Date());
        const now = new Date();
        let nextDate = new Date(startDate);
        
        if (debt.regularIncrement.lastIncrement) {
            nextDate = new Date(debt.regularIncrement.lastIncrement);
        }
        
        while (nextDate <= now) {
            switch (debt.regularIncrement.frequency) {
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'fortnightly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'triweekly':
                    nextDate.setDate(nextDate.getDate() + 21);
                    break;
                case 'monthly':
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    break;
            }
        }
        
        return nextDate.toLocaleDateString();
    }

    // Process regular increments
    function processRegularIncrements() {
        const now = new Date();
        let updated = false;
        
        debts.forEach(debt => {
            if (debt.regularIncrement && debt.regularIncrement.enabled && debt.regularIncrement.amount > 0) {
                const lastIncrement = debt.regularIncrement.lastIncrement ? 
                    new Date(debt.regularIncrement.lastIncrement) : 
                    new Date(debt.regularIncrement.startDate || new Date());
                
                let nextIncrement = new Date(lastIncrement);
                
                switch (debt.regularIncrement.frequency) {
                    case 'weekly':
                        nextIncrement.setDate(nextIncrement.getDate() + 7);
                        break;
                    case 'fortnightly':
                        nextIncrement.setDate(nextIncrement.getDate() + 14);
                        break;
                    case 'triweekly':
                        nextIncrement.setDate(nextIncrement.getDate() + 21);
                        break;
                    case 'monthly':
                        nextIncrement.setMonth(nextIncrement.getMonth() + 1);
                        break;
                }
                
                if (nextIncrement <= now) {
                    const oldAmount = debt.amount;
                    debt.amount += debt.regularIncrement.amount;
                    debt.regularIncrement.lastIncrement = nextIncrement.toISOString();
                    updated = true;
                    
                    // Add log entry
                    if (!debt.logs) debt.logs = [];
                    debt.logs.unshift({
                        type: 'increment',
                        description: `Auto-increment of ¬£${debt.regularIncrement.amount} applied. Balance increased from ¬£${oldAmount.toFixed(2)} to ¬£${debt.amount.toFixed(2)}`,
                        timestamp: new Date().toISOString(),
                        amount: debt.regularIncrement.amount,
                        previousAmount: oldAmount,
                        newAmount: debt.amount
                    });
                    
                    showNotification(`Auto-incremented ${debt.name} by ¬£${debt.regularIncrement.amount}`, 'info');
                }
            }
        });
        
        if (updated) {
            saveDebtsToLocalStorage();
            renderDebtCards();
            updateTotalDebt();
            lastRefreshTime = new Date();
            updateRefreshInfo();
        }
        
        return updated;
    }

    // Show notification
    function showNotification(message, type = 'success') {
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }

    // Update refresh info
    function updateRefreshInfo() {
        if (lastRefreshTime) {
            lastRefreshTimeElement.textContent = lastRefreshTime.toLocaleString();
            const nextRefresh = new Date(lastRefreshTime.getTime() + 60 * 60 * 1000);
            nextRefreshTimeElement.textContent = nextRefresh.toLocaleString();
            refreshInfo.style.display = 'block';
        }
    }

    // Auto-refresh functionality
    function startAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        lastRefreshTime = new Date();
        updateRefreshInfo();
        
        autoRefreshInterval = setInterval(() => {
            const updated = processRegularIncrements();
            if (updated) {
                lastRefreshTime = new Date();
                updateRefreshInfo();
            }
        }, 60 * 60 * 1000);
    }

    // ====================
    // EVENT LISTENERS
    // ====================

    addDebtBtn.addEventListener('click', () => {
        addDebtModal.style.display = 'flex';
    });

    closeAddModal.addEventListener('click', () => {
        addDebtModal.style.display = 'none';
    });

    cancelBtn.addEventListener('click', () => {
        addDebtModal.style.display = 'none';
        resetForm();
    });

    debtForm.addEventListener('submit', addDebt);

    // Pay modal events
    closePayModal.addEventListener('click', () => {
        payModal.style.display = 'none';
    });

    cancelPayBtn.addEventListener('click', () => {
        payModal.style.display = 'none';
    });

    confirmPayBtn.addEventListener('click', processPayment);

    payAmount.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            processPayment();
        }
    });

    // Notes popup events
    closeNotes.addEventListener('click', () => {
        notesPopup.style.display = 'none';
        notesOverlay.style.display = 'none';
    });

    editNotesBtn.addEventListener('click', toggleNotesEditing);
    saveNotesBtn.addEventListener('click', saveNotes);

    notesOverlay.addEventListener('click', () => {
        notesPopup.style.display = 'none';
        notesOverlay.style.display = 'none';
    });

    // Export/Import event listeners
    exportBtn.addEventListener('click', saveDataToJSON);
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            importDataFromJSON(e.target.files[0]);
            e.target.value = '';
        }
    });

    // Data source toggle
    document.getElementById('autoSource').addEventListener('change', toggleDataSource);
    document.getElementById('manualSource').addEventListener('change', toggleDataSource);

    // Close modals when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target === addDebtModal) {
            addDebtModal.style.display = 'none';
            resetForm();
        }
        if (event.target === payModal) {
            payModal.style.display = 'none';
        }
    });

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>
