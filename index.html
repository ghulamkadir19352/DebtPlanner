<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Dashboard</title>

    <style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --danger-color: #e74c3c;
    --success-color: #2ecc71;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --text-color: #333;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: var(--light-bg);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 30px;
}

h1 {
    color: var(--secondary-color);
    font-size: 2rem;
}

.total-debt {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--danger-color);
}

.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.debt-card {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
    min-height: 100px;
}

.debt-card:hover {
    transform: translateY(-5px);
}

.debt-content {
    flex: 1;
    margin-right: 15px;
}

.debt-logo {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.debt-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.debt-name.clickable {
    cursor: pointer;
    color: var(--primary-color);
    text-decoration: underline;
    transition: color 0.3s ease;
}

.debt-name.clickable:hover {
    color: #2980b9;
}

.debt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--danger-color);
}

.settings-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.settings-btn:hover {
    background-color: #2980b9;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-color);
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

input[type="text"],
input[type="password"],
input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
}

.manual-amount {
    display: none;
    margin-top: 10px;
}

/* Notes and Info Icon Styles */
.debt-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-icon {
    color: var(--primary-color);
    cursor: pointer;
    font-size: 1rem;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.info-icon:hover {
    opacity: 1;
}

.notes-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 1001;
    max-width: 400px;
    width: 90%;
    max-height: 300px;
    overflow-y: auto;
}

.notes-popup h3 {
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.notes-popup .notes-content {
    white-space: pre-wrap;
    line-height: 1.4;
}

.notes-popup-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

/* Textarea styling */
textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
}


.btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-secondary {
    background-color: var(--border-color);
    color: var(--text-color);
}

.debt-list {
    margin-top: 20px;
}

.debt-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.debt-item:last-child {
    border-bottom: none;
}

/* Debt display styles */
.debt-display {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
}

.debt-info {
    flex-grow: 1;
}

.debt-amount-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.amount-label {
    font-weight: 500;
}

.amount-input {
    width: 100px;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
}

.update-amount-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.update-amount-btn:hover {
    background-color: #2980b9;
}

.debt-meta {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}

.debt-source {
    font-size: 0.8rem;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    background-color: var(--primary-color);
}

.debt-url {
    font-size: 0.8rem;
    color: var(--text-light);
    padding: 2px 8px;
    background-color: #f8f9fa;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.debt-actions {
    display: flex;
    flex-direction: column;
    gap: 5px;
    min-width: 100px;
}

.edit-btn {
    background-color: var(--success-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.edit-btn:hover {
    background-color: #27ae60;
}

.delete-btn {
    background-color: var(--danger-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.delete-btn:hover {
    background-color: #c0392b;
}

/* Remove number input spinners */
.amount-input,
.no-spinner,
input[type="number"] {
    -moz-appearance: textfield;
}

.amount-input::-webkit-outer-spin-button,
.amount-input::-webkit-inner-spin-button,
.no-spinner::-webkit-outer-spin-button,
.no-spinner::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Edit form styles */
.debt-edit-form {
    display: none;
    margin-top: 0;
    padding: 0;
    background-color: transparent;
    border-left: none;
}

.debt-edit-form.edit-form-expanded {
    display: block;
    width: 100%;
}

.edit-form-content {
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 2px solid var(--primary-color);
    box-shadow: var(--shadow);
}

.edit-form-content h4 {
    margin-bottom: 20px;
    color: var(--secondary-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}

.edit-auto-fields,
.edit-manual-amount {
    margin-top: 15px;
}

.cancel-edit-btn {
    background-color: #6c757d;
}

.cancel-edit-btn:hover {
    background-color: #5a6268;
}

/* Ensure form elements in edit mode use full width */
.edit-form-content .form-group {
    margin-bottom: 20px;
}

.edit-form-content label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.edit-form-content input[type="text"],
.edit-form-content input[type="password"],
.edit-form-content input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.edit-form-content .radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.edit-form-content .radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
}

.edit-form-content .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.refresh-info {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    font-size: 0.9rem;
    color: var(--text-light);
    display: none;
}
</style>


</head>
<body>
    <div class="container">
        <header>
            <h1>Debt Dashboard</h1>
            <div class="total-debt">Total: Â£0.00</div>
        </header>
        
        <div class="dashboard" id="debtDashboard">
            <!-- Debt cards will be dynamically added here -->
        </div>

        <div class="refresh-info" id="refreshInfo" style="display: none;">
            Last refreshed: <span id="lastRefreshTime">Never</span><br>
            Next refresh: <span id="nextRefreshTime">Calculating...</span>
        </div>
        
        <button class="settings-btn" id="settingsBtn">Settings</button>
        
        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Debt Settings</h2>
                    <button class="close-btn" id="closeModal">&times;</button>
                </div>
                
                <form id="debtForm">
                    <div class="form-group">
                        <label for="debtName">Debt Name</label>
                        <input type="text" id="debtName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Data Source</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="autoSource" name="dataSource" value="auto" checked>
                                <label for="autoSource">Automated (Selenium)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="manualSource" name="dataSource" value="manual">
                                <label for="manualSource">Manual Entry</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="autoFields">
                        <div class="form-group">
                            <label for="loginUrl">Login URL</label>
                            <input type="text" id="loginUrl">
                        </div>
                        
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password">
                        </div>
                    </div>
                    
                    <div class="form-group manual-amount" id="manualFields">
                        <label for="amount">Amount (Â£)</label>
                        <input type="number" id="amount" step="0.01" class="no-spinner">
                    </div>

                    <div class="form-group">
                         <label for="directLink">Direct Link</label>
                         <input type="text" id="directLink" placeholder="https://...">
                            <small style="color: var(--text-light); font-size: 0.8rem;">
                             If provided, the debt card will be clickable and open this link
                            </small>
                    </div>

                    
                    <div class="form-group">
                          <label for="notes">Notes</label>
                            <textarea id="notes" rows="3" placeholder="Add any notes about this debt..."></textarea>
                     </div>

                    <div class="form-group">
                        <label for="cardColor">Card Color</label>
                         <input type="color" id="cardColor" value="#ffffff">
                    </div>

                    <div class="form-group">
                        <label for="titleColor">Title Color</label>
                        <input type="color" id="titleColor" value="#2c3e50">
                    </div>

                    <div class="form-group">
                        <label for="logoImage">Logo Image</label>
                        <input type="file" id="logoImage" accept="image/*">
                         <small style="color: var(--text-light); font-size: 0.8rem;">
                              Select a square image from your local machine
                         </small>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Debt</button>
                    </div>
                </form>
                
                <div class="debt-list" id="debtList">
                    <!-- Existing debts will be listed here -->
                </div>
            </div>
        </div>
    </div>

    
<script>
    // Sample data - in a real app, this would come from a database
    let debts = [];
    let logoFile = null; // Add this missing variable

    // DOM Elements
    const debtDashboard = document.getElementById('debtDashboard');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const debtForm = document.getElementById('debtForm');
    const debtList = document.getElementById('debtList');
    const autoSource = document.getElementById('autoSource');
    const manualSource = document.getElementById('manualSource');
    const autoFields = document.getElementById('autoFields');
    const manualFields = document.getElementById('manualFields');
    const totalDebtElement = document.querySelector('.total-debt');
    const logoImageInput = document.getElementById('logoImage');

    // Initialize the dashboard
    function initDashboard() {
        debts = loadDebts(); // Load from localStorage
        renderDebtCards();
        updateTotalDebt();
        renderDebtList();
        
        // Auto-refresh is disabled by default since backend doesn't exist
        // enableBackendConnection(); // Uncomment this when backend is ready
    }

    // Render debt cards on the dashboard
    function renderDebtCards() {
        debtDashboard.innerHTML = '';
        
        debts.forEach(debt => {
            const debtCard = document.createElement('div');
            debtCard.className = 'debt-card';
            
            debtCard.innerHTML = `
                <div class="debt-content">
                    <div class="debt-title">
                        <div class="debt-name ${debt.direct_link ? 'clickable' : ''}" style="color: ${debt.titleColor || 'var(--secondary-color)'}">${debt.name}</div>
                        ${debt.notes ? `<span class="info-icon" data-id="${debt.id}">â¹ï¸</span>` : ''}
                    </div>
                    <div class="debt-amount">Â£${debt.amount.toFixed(2)}</div>
                </div>
                ${debt.logoImage ? `<img src="${debt.logoImage}" alt="${debt.name} logo" class="debt-logo">` : ''}
            `;

            // Set custom card background color
            if (debt.cardColor && debt.cardColor !== '#ffffff') {
                debtCard.style.backgroundColor = debt.cardColor;
            }

            // Add click handler for debt name if direct link exists
            if (debt.direct_link) {
                const debtName = debtCard.querySelector('.debt-name.clickable');
                debtName.addEventListener('click', (e) => {
                    e.stopPropagation();
                    window.open(debt.direct_link, '_blank');
                });
            }

            debtDashboard.appendChild(debtCard);
        });
        
        // Add event listeners for info icons
        document.querySelectorAll('.info-icon').forEach(icon => {
            icon.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent triggering card click if it's clickable
                const id = parseInt(icon.getAttribute('data-id'));
                showNotesPopup(id);
            });
        });
    }

    // Update the total debt display
    function updateTotalDebt() {
        const total = debts.reduce((sum, debt) => sum + debt.amount, 0);
        totalDebtElement.textContent = `Total: Â£${total.toFixed(2)}`;
    }

    // Update debt amount
    function updateDebtAmount(id, newAmount) {
        const debt = debts.find(d => d.id === id);
        if (debt) {
            debt.amount = newAmount;
            saveDebts(); // Save to localStorage
            renderDebtCards();
            updateTotalDebt();
            showRefreshNotification(`Updated ${debt.name} to Â£${newAmount.toFixed(2)}`);
        }
    }

    // Render the list of debts in the settings modal with edit capability
    function renderDebtList() {
        debtList.innerHTML = '';
        
        if (debts.length === 0) {
            debtList.innerHTML = '<p>No debts configured yet.</p>';
            return;
        }
        
        debts.forEach(debt => {
            const debtItem = document.createElement('div');
            debtItem.className = 'debt-item';
            debtItem.innerHTML = `
                <div class="debt-display">
                    <div class="debt-info">
                        <strong>${debt.name}</strong>
                        <div class="debt-amount-controls">
                            <span class="amount-label">Amount: Â£</span>
                            <input type="number" class="amount-input" value="${debt.amount.toFixed(2)}" step="0.01" data-id="${debt.id}">
                            <button class="update-amount-btn" data-id="${debt.id}">Update</button>
                        </div>
                        <div class="debt-meta">
                            <span class="debt-source">${debt.source === 'manual' ? 'Manual' : 'Automated'}</span>
                            ${debt.source === 'auto' ? `<span class="debt-url">${debt.login_url || 'No URL'}</span>` : ''}
                        </div>
                    </div>
                    <div class="debt-actions">
                        <button class="edit-btn" data-id="${debt.id}">Edit</button>
                        <button class="delete-btn" data-id="${debt.id}">Delete</button>
                    </div>
                </div>
                <div class="debt-edit-form" id="edit-form-${debt.id}" style="display: none;">
                    <div class="edit-form-content">
                        <h4>Edit ${debt.name}</h4>
                        <form class="edit-debt-form" data-id="${debt.id}">
                            <div class="form-group">
                                <label for="edit-name-${debt.id}">Debt Name</label>
                                <input type="text" id="edit-name-${debt.id}" value="${debt.name}" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Data Source</label>
                                <div class="radio-group">
                                    <div class="radio-option">
                                        <input type="radio" id="edit-auto-${debt.id}" name="edit-dataSource-${debt.id}" value="auto" ${debt.source === 'auto' ? 'checked' : ''}>
                                        <label for="edit-auto-${debt.id}">Automated (Selenium)</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="edit-manual-${debt.id}" name="edit-dataSource-${debt.id}" value="manual" ${debt.source === 'manual' ? 'checked' : ''}>
                                        <label for="edit-manual-${debt.id}">Manual Entry</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="edit-auto-fields" id="edit-auto-fields-${debt.id}" style="${debt.source === 'auto' ? '' : 'display: none;'}">
                                <div class="form-group">
                                    <label for="edit-loginUrl-${debt.id}">Login URL</label>
                                    <input type="text" id="edit-loginUrl-${debt.id}" value="${debt.login_url || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-username-${debt.id}">Username</label>
                                    <input type="text" id="edit-username-${debt.id}" value="${debt.username || ''}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="edit-password-${debt.id}">Password</label>
                                    <input type="password" id="edit-password-${debt.id}" value="" placeholder="Enter new password">
                                </div>
                            </div>
                            
                            <div class="form-group edit-manual-amount" id="edit-manual-fields-${debt.id}" style="${debt.source === 'manual' ? '' : 'display: none;'}">
                                <label for="edit-amount-${debt.id}">Amount (Â£)</label>
                                <input type="number" id="edit-amount-${debt.id}" value="${debt.amount}" step="0.01" class="no-spinner">
                            </div>

                            <div class="form-group">
                                <label for="edit-directLink-${debt.id}">Direct Link</label>
                                <input type="text" id="edit-directLink-${debt.id}" value="${debt.direct_link || ''}" placeholder="https://...">
                                <small style="color: var(--text-light); font-size: 0.8rem;">
                                    If provided, the debt card will be clickable and open this link
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="edit-notes-${debt.id}">Notes</label>
                                <textarea id="edit-notes-${debt.id}" rows="3" placeholder="Add any notes about this debt...">${debt.notes || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label for="edit-cardColor-${debt.id}">Card Color</label>
                                <input type="color" id="edit-cardColor-${debt.id}" value="${debt.cardColor || '#ffffff'}">
                            </div>

                            <div class="form-group">
                                <label for="edit-titleColor-${debt.id}">Title Color</label>
                                <input type="color" id="edit-titleColor-${debt.id}" value="${debt.titleColor || '#2c3e50'}">
                            </div>

                            <div class="form-group">
                                <label for="edit-logoImage-${debt.id}">Logo Image</label>
                                <input type="file" id="edit-logoImage-${debt.id}" accept="image/*">
                                ${debt.logoImage ? '<small style="color: var(--success-color);">Current image loaded</small>' : ''}
                            </div>

                            <div class="btn-group">
                                <button type="button" class="btn btn-secondary cancel-edit-btn" data-id="${debt.id}">Cancel</button>
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            debtList.appendChild(debtItem);
        });
        
        // Add event listeners
        document.querySelectorAll('.update-amount-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                const input = document.querySelector(`.amount-input[data-id="${id}"]`);
                const newAmount = parseFloat(input.value) || 0;
                updateDebtAmount(id, newAmount);
            });
        });
        
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                toggleEditForm(id);
            });
        });
        
        document.querySelectorAll('.cancel-edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                toggleEditForm(id, false);
            });
        });
        
        document.querySelectorAll('.edit-debt-form').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const id = parseInt(this.getAttribute('data-id'));
                saveDebtChanges(id);
            });
        });
        
        document.querySelectorAll('input[name^="edit-dataSource-"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const id = this.id.split('-')[2];
                toggleEditDataSource(id);
            });
        });
        
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const id = parseInt(this.getAttribute('data-id'));
                deleteDebt(id);
            });
        });
    }

    // Delete a debt
    function deleteDebt(id) {
        if (confirm('Are you sure you want to delete this debt?')) {
            debts = debts.filter(debt => debt.id !== id);
            saveDebts(); // Save to localStorage
            renderDebtCards();
            updateTotalDebt();
            renderDebtList();
        }
    }

    // Show notes popup
    function showNotesPopup(id) {
        const debt = debts.find(d => d.id === id);
        if (!debt || !debt.notes) return;
        
        // Create popup overlay
        const overlay = document.createElement('div');
        overlay.className = 'notes-popup-overlay';
        overlay.style.display = 'block';
        
        // Create popup content
        const popup = document.createElement('div');
        popup.className = 'notes-popup';
        popup.innerHTML = `
            <h3>${debt.name} - Notes</h3>
            <div class="notes-content">${debt.notes}</div>
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-primary close-notes-btn">Close</button>
            </div>
        `;
        
        // Add to page
        document.body.appendChild(overlay);
        document.body.appendChild(popup);
        
        // Show popup
        popup.style.display = 'block';
        
        // Close functionality
        const closeBtn = popup.querySelector('.close-notes-btn');
        const closePopup = () => {
            document.body.removeChild(overlay);
            document.body.removeChild(popup);
        };
        
        closeBtn.addEventListener('click', closePopup);
        overlay.addEventListener('click', closePopup);
        
        // Close on escape key
        const handleEscape = (e) => {
            if (e.key === 'Escape') {
                closePopup();
                document.removeEventListener('keydown', handleEscape);
            }
        };
        document.addEventListener('keydown', handleEscape);
    }

    // Toggle between manual and automated fields
    function toggleDataSource() {
        if (manualSource.checked) {
            autoFields.style.display = 'none';
            manualFields.style.display = 'block';
        } else {
            autoFields.style.display = 'block';
            manualFields.style.display = 'none';
        }
    }

    // Add a new debt
    function addDebt(event) {
        event.preventDefault();
        
        const debtName = document.getElementById('debtName').value;
        const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
        const notes = document.getElementById('notes').value;
        const directLink = document.getElementById('directLink').value; 
        
        let amount = 0;
        let login_url = '';
        let username = '';
        let password = '';
        
        if (dataSource === 'manual') {
            amount = parseFloat(document.getElementById('amount').value) || 0;
        } else {
            amount = 0;
            login_url = document.getElementById('loginUrl').value;
            username = document.getElementById('username').value;
            password = document.getElementById('password').value;
            alert('Automated debt added. Amount will be updated when scraper runs.');
        }
        
        const newDebt = {
            id: Date.now(),
            name: debtName,
            amount: amount,
            source: dataSource,
            login_url: login_url,
            username: username,
            password: password,
            notes: notes,
            direct_link: directLink,
            cardColor: document.getElementById('cardColor').value,
            titleColor: document.getElementById('titleColor').value,
            logoImage: ''
        };
        
        // Handle logo image if selected
        const logoFile = document.getElementById('logoImage').files[0];
        if (logoFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                newDebt.logoImage = e.target.result;
                debts.push(newDebt);
                saveDebts();
                renderDebtCards();
                updateTotalDebt();
                renderDebtList();
                resetForm();
            };
            reader.readAsDataURL(logoFile);
        } else {
            debts.push(newDebt);
            saveDebts();
            renderDebtCards();
            updateTotalDebt();
            renderDebtList();
            resetForm();
        }
    }

    // Reset form function
    function resetForm() {
        debtForm.reset();
        document.getElementById('cardColor').value = '#ffffff';
        document.getElementById('titleColor').value = '#2c3e50';
        document.getElementById('logoImage').value = '';
        settingsModal.style.display = 'none';
        logoFile = null;
    }

    // Toggle edit form visibility
    function toggleEditForm(id, show = true) {
        const debtItem = document.querySelector(`.debt-item [data-id="${id}"]`).closest('.debt-item');
        const editForm = document.getElementById(`edit-form-${id}`);
        const debtDisplay = debtItem.querySelector('.debt-display');
        
        if (show) {
            debtDisplay.style.display = 'none';
            editForm.style.display = 'block';
            editForm.classList.add('edit-form-expanded');
        } else {
            debtDisplay.style.display = 'flex';
            editForm.style.display = 'none';
            editForm.classList.remove('edit-form-expanded');
            // Re-render to reset any unsaved changes
            renderDebtList();
        }
    }

    // Toggle data source fields in edit form
    function toggleEditDataSource(id) {
        const isManual = document.getElementById(`edit-manual-${id}`).checked;
        const autoFields = document.getElementById(`edit-auto-fields-${id}`);
        const manualFields = document.getElementById(`edit-manual-fields-${id}`);
        
        if (isManual) {
            autoFields.style.display = 'none';
            manualFields.style.display = 'block';
        } else {
            autoFields.style.display = 'block';
            manualFields.style.display = 'none';
        }
    }

    // Save all changes from edit form
    function saveDebtChanges(id) {
        const debt = debts.find(d => d.id === id);
        if (!debt) return;
        
        const newName = document.getElementById(`edit-name-${id}`).value;
        const newDataSource = document.querySelector(`input[name="edit-dataSource-${id}"]:checked`).value;
        const newAmount = parseFloat(document.getElementById(`edit-amount-${id}`).value) || 0;
        const newNotes = document.getElementById(`edit-notes-${id}`).value;
        const newDirectLink = document.getElementById(`edit-directLink-${id}`).value;
        const logoFile = document.getElementById(`edit-logoImage-${id}`).files[0];
        
        // Update debt properties
        debt.name = newName;
        debt.source = newDataSource;
        debt.amount = newAmount;
        debt.notes = newNotes;
        debt.direct_link = newDirectLink;
        debt.cardColor = document.getElementById(`edit-cardColor-${id}`).value;
        debt.titleColor = document.getElementById(`edit-titleColor-${id}`).value;
        
        // Handle logo image if a new one is selected
        if (logoFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                debt.logoImage = e.target.result;
                completeSaveDebtChanges(debt, newDataSource, id);
            };
            reader.readAsDataURL(logoFile);
        } else {
            completeSaveDebtChanges(debt, newDataSource, id);
        }
    }

    function completeSaveDebtChanges(debt, newDataSource, id) {
        // Update automated fields if applicable
        if (newDataSource === 'auto') {
            debt.login_url = document.getElementById(`edit-loginUrl-${id}`).value;
            debt.username = document.getElementById(`edit-username-${id}`).value;
            
            // Only update password if a new one was entered
            const newPassword = document.getElementById(`edit-password-${id}`).value;
            if (newPassword) {
                debt.password = newPassword;
            }
        } else {
            // Clear automated fields if switching to manual
            debt.login_url = '';
            debt.username = '';
            debt.password = '';
        }
        
        saveDebts(); // Save to localStorage
        renderDebtCards();
        updateTotalDebt();
        renderDebtList(); // Re-render to close edit form
        showRefreshNotification(`Updated ${debt.name} successfully`);
    }

    // Save debts to localStorage
    function saveDebts() {
        localStorage.setItem('debtDashboard', JSON.stringify(debts));
    }

    // Load debts from localStorage
    function loadDebts() {
        const saved = localStorage.getItem('debtDashboard');
        if (saved) {
            return JSON.parse(saved);
        }
        // Return sample data if nothing saved
        return [
            { 
                id: 1, 
                name: "Octopus Energy", 
                amount: 1000.00, 
                source: "manual", 
                notes: "Monthly: Â£75", 
                direct_link: "https://example.com", 
                cardColor: "#ffffff", 
                titleColor: "#2c3e50", 
                logoImage: "" 
            },
            { 
                id: 2, 
                name: "Jacobs (Council Tax)", 
                amount: 1000.00, 
                source: "manual", 
                notes: "Monthly: Â£75", 
                direct_link: "https://example.com", 
                cardColor: "#ffffff", 
                titleColor: "#2c3e50", 
                logoImage: "" 
            },
            { 
                id: 3, 
                name: "Link Financial", 
                amount: 1000.00, 
                source: "manual", 
                notes: "Monthly: Â£75", 
                direct_link: "https://example.com", 
                cardColor: "#ffffff", 
                titleColor: "#2c3e50", 
                logoImage: "" 
            },
            { 
                id: 4, 
                name: "Great Places", 
                amount: 1000.00, 
                source: "manual", 
                notes: "Monthly: Â£75", 
                direct_link: "https://example.com", 
                cardColor: "#ffffff", 
                titleColor: "#2c3e50", 
                logoImage: "" 
            },
            { 
                id: 5, 
                name: "Bashir", 
                amount: 1000.00, 
                source: "manual", 
                notes: "Monthly: Â£75", 
                direct_link: "https://example.com", 
                cardColor: "#ffffff", 
                titleColor: "#2c3e50", 
                logoImage: "" 
            },
            { 
                id: 6, 
                name: "Abdul", 
                amount: 1000.00, 
                source: "manual", 
                notes: "Monthly: Â£75", 
                direct_link: "https://example.com", 
                cardColor: "#ffffff", 
                titleColor: "#2c3e50", 
                logoImage: "" 
            }
        ];
    }

    // Auto-refresh functionality - Only active when backend is connected
    let refreshInterval = 12 * 60 * 60 * 1000; // 12 hours in milliseconds
    let lastRefreshTime = Date.now();
    let refreshTimer;
    let backendConnected = false; // Set to true when backend is functional

    function startAutoRefresh() {
        // Only start if backend is connected
        if (!backendConnected) {
            console.log('Auto-refresh disabled: Backend not connected');
            return;
        }
        
        refreshTimer = setInterval(() => {
            refreshDebtData();
        }, refreshInterval);
        
        updateRefreshInfo();
    }

    function refreshDebtData() {
        // Only refresh if backend is connected
        if (!backendConnected) {
            console.log('Refresh skipped: Backend not connected');
            return;
        }
        
        console.log('Refreshing debt data from backend...');
        
        document.querySelectorAll('.debt-card').forEach(card => {
            card.style.opacity = '0.7';
        });
        
        // In a real implementation, this would call your backend API
        // For now, simulate backend call
        simulateBackendRefresh();
    }

    function simulateBackendRefresh() {
        setTimeout(() => {
            // Simulate updated amounts
            debts.forEach(debt => {
                if (debt.source === 'auto') {
                    // Simulate a small random change
                    const change = (Math.random() - 0.5) * 20;
                    debt.amount = Math.max(0, debt.amount + change);
                }
            });
            
            saveDebts();
            renderDebtCards();
            updateTotalDebt();
            lastRefreshTime = Date.now();
            updateRefreshInfo();
            showRefreshNotification('Debt data refreshed from backend');
        }, 2000);
    }

    function updateRefreshInfo() {
        const refreshInfo = document.getElementById('refreshInfo');
        const lastRefreshTimeElement = document.getElementById('lastRefreshTime');
        const nextRefreshTimeElement = document.getElementById('nextRefreshTime');
        
        if (!backendConnected) {
            refreshInfo.style.display = 'none';
            return;
        }
        
        refreshInfo.style.display = 'block';
        
        // Format last refresh time
        const lastRefresh = new Date(lastRefreshTime);
        lastRefreshTimeElement.textContent = lastRefresh.toLocaleString();
        
        // Calculate next refresh time
        const nextRefresh = new Date(lastRefreshTime + refreshInterval);
        nextRefreshTimeElement.textContent = nextRefresh.toLocaleString();
    }

    function showRefreshNotification(message) {
        // Create a simple notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            z-index: 1002;
            transition: opacity 0.3s ease;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    function enableBackendConnection() {
        backendConnected = true;
        startAutoRefresh();
        updateRefreshInfo();
    }

    // Event Listeners
    settingsBtn.addEventListener('click', () => {
        settingsModal.style.display = 'flex';
    });

    closeModal.addEventListener('click', () => {
        settingsModal.style.display = 'none';
    });

    cancelBtn.addEventListener('click', () => {
        settingsModal.style.display = 'none';
    });

    debtForm.addEventListener('submit', addDebt);

    autoSource.addEventListener('change', toggleDataSource);
    manualSource.addEventListener('change', toggleDataSource);

    // Close modal when clicking outside
    window.addEventListener('click', (event) => {
        if (event.target === settingsModal) {
            settingsModal.style.display = 'none';
        }
    });

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', initDashboard);
</script>

</body>
</html>