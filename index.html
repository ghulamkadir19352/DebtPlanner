<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debt Dashboard</title>

    <style>
:root {
    --primary-color: #3498db;
    --secondary-color: #2c3e50;
    --danger-color: #e74c3c;
    --success-color: #2ecc71;
    --light-bg: #f8f9fa;
    --border-color: #dee2e6;
    --text-color: #333;
    --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: var(--light-bg);
    color: var(--text-color);
    line-height: 1.6;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: 30px;
}

h1 {
    color: var(--secondary-color);
    font-size: 2rem;
}

.total-debt {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--danger-color);
}

.dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.debt-card {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
    min-height: 100px;
}

.debt-card:hover {
    transform: translateY(-5px);
}

.debt-content {
    flex: 1;
    margin-right: 15px;
}

.debt-logo {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.debt-name {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.debt-name.clickable {
    cursor: pointer;
    color: var(--primary-color);
    text-decoration: underline;
    transition: color 0.3s ease;
}

.debt-name.clickable:hover {
    color: #2980b9;
}

.debt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--danger-color);
}

.settings-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.settings-btn:hover {
    background-color: #2980b9;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--text-color);
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

input[type="text"],
input[type="password"],
input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
}

.manual-amount {
    display: none;
    margin-top: 10px;
}

/* Notes and Info Icon Styles */
.debt-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-icon {
    color: var(--primary-color);
    cursor: pointer;
    font-size: 1rem;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.info-icon:hover {
    opacity: 1;
}

.notes-popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 1001;
    max-width: 400px;
    width: 90%;
    max-height: 300px;
    overflow-y: auto;
}

.notes-popup h3 {
    margin-bottom: 10px;
    color: var(--secondary-color);
}

.notes-popup .notes-content {
    white-space: pre-wrap;
    line-height: 1.4;
}

.notes-popup-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
}

/* Textarea styling */
textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    min-height: 80px;
}


.btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}

.btn-secondary {
    background-color: var(--border-color);
    color: var(--text-color);
}

.debt-list {
    margin-top: 20px;
}

.debt-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
}

.debt-item:last-child {
    border-bottom: none;
}

/* Debt display styles */
.debt-display {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
}

.debt-info {
    flex-grow: 1;
}

.debt-amount-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.amount-label {
    font-weight: 500;
}

.amount-input {
    width: 100px;
    padding: 5px;
    border: 1px solid var(--border-color);
    border-radius: 3px;
}

.update-amount-btn {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.8rem;
}

.update-amount-btn:hover {
    background-color: #2980b9;
}

.debt-meta {
    display: flex;
    gap: 10px;
    margin-top: 5px;
}

.debt-source {
    font-size: 0.8rem;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    background-color: var(--primary-color);
}

.debt-url {
    font-size: 0.8rem;
    color: var(--text-light);
    padding: 2px 8px;
    background-color: #f8f9fa;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}





/* Remove number input spinners */
.amount-input,
.no-spinner,
input[type="number"] {
    -moz-appearance: textfield;
}

.amount-input::-webkit-outer-spin-button,
.amount-input::-webkit-inner-spin-button,
.no-spinner::-webkit-outer-spin-button,
.no-spinner::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

/* Edit form styles */
.debt-edit-form {
    display: none;
    margin-top: 0;
    padding: 0;
    background-color: transparent;
    border-left: none;
}

.debt-edit-form.edit-form-expanded {
    display: block;
    width: 100%;
}

.edit-form-content {
    padding: 20px;
    background-color: white;
    border-radius: 8px;
    border: 2px solid var(--primary-color);
    box-shadow: var(--shadow);
}

.edit-form-content h4 {
    margin-bottom: 20px;
    color: var(--secondary-color);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 10px;
}

.edit-auto-fields,
.edit-manual-amount {
    margin-top: 15px;
}

.cancel-edit-btn {
    background-color: #6c757d;
}

.cancel-edit-btn:hover {
    background-color: #5a6268;
}

/* Ensure form elements in edit mode use full width */
.edit-form-content .form-group {
    margin-bottom: 20px;
}

.edit-form-content label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
}

.edit-form-content input[type="text"],
.edit-form-content input[type="password"],
.edit-form-content input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 1rem;
}

.edit-form-content .radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.edit-form-content .radio-option {
    display: flex;
    align-items: center;
    gap: 5px;
}

.edit-form-content .btn-group {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.refresh-info {
    text-align: center;
    margin: 20px 0;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 5px;
    font-size: 0.9rem;
    color: var(--text-light);
    display: none;
}

/* Icon button styles */
.icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.1rem;
    width: 32px;
    height: 32px;
}

.update-btn {
    color: var(--primary-color);
    background-color: rgba(52, 152, 219, 0.1);
}

.update-btn:hover {
    background-color: rgba(52, 152, 219, 0.2);
    transform: scale(1.1);
}

.edit-btn-icon {
    color: var(--success-color);
    background-color: rgba(46, 204, 113, 0.1);
}

.edit-btn-icon:hover {
    background-color: rgba(46, 204, 113, 0.2);
    transform: scale(1.1);
}

.delete-btn-icon {
    color: var(--danger-color);
    background-color: rgba(231, 76, 60, 0.1);
}

.delete-btn-icon:hover {
    background-color: rgba(231, 76, 60, 0.2);
    transform: scale(1.1);
}



/* Regular increment styles */
.regular-increment-section {
    margin-top: 15px;
    padding: 15px;
    background-color: var(--light-bg);
    border-radius: 6px;
    border-left: 4px solid var(--primary-color);
}

.increment-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    cursor: pointer;
}

.increment-toggle input[type="checkbox"] {
    width: 16px;
    height: 16px;
}

.increment-toggle label {
    margin-bottom: 0;
    font-weight: 600;
    color: var(--secondary-color);
    cursor: pointer;
}

.increment-fields {
    display: none;
    gap: 15px;
    flex-wrap: wrap;
}

.increment-fields.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.increment-field {
    flex: 1;
    min-width: 150px;
}

.increment-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 0.9rem;
}

.increment-amount-input,
.increment-frequency-select {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 0.9rem;
}

.increment-preview {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: white;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    color: var(--text-color);
}

.increment-preview .next-increment {
    color: var(--primary-color);
    font-weight: 600;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Amount styling */
.debt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    transition: color 0.3s ease;
}

/* Card layout improvements */
.debt-card {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
    min-height: 100px;
}

.debt-content {
    flex: 1;
    margin-right: 15px;
    min-width: 0;
}

.debt-meta-info {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-light);
}

.increment-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background-color: rgba(46, 204, 113, 0.1);
    color: var(--success-color);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-top: 4px;
}

/* Improved Icon Button Styles */
.icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-size: 1.1rem;
    width: 32px;
    height: 32px;
}

.update-btn {
    color: var(--primary-color);
    background-color: rgba(52, 152, 219, 0.1);
}

.update-btn:hover {
    background-color: rgba(52, 152, 219, 0.2);
    transform: scale(1.1);
}

.edit-btn-icon {
    color: var(--success-color);
    background-color: rgba(46, 204, 113, 0.1);
}

.edit-btn-icon:hover {
    background-color: rgba(46, 204, 113, 0.2);
    transform: scale(1.1);
}

.delete-btn-icon {
    color: var(--danger-color);
    background-color: rgba(231, 76, 60, 0.1);
}

.delete-btn-icon:hover {
    background-color: rgba(231, 76, 60, 0.2);
    transform: scale(1.1);
}

/* Improved Debt Actions Layout */
.debt-actions {
    display: flex;
    flex-direction: row;
    gap: 8px;
    min-width: auto;
    align-items: center;
}

.debt-amount-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
    flex-wrap: wrap;
}

.amount-input {
    width: 120px;
    padding: 6px 8px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.9rem;
}

/* Regular Increment Styles */
.regular-increment-section {
    margin-top: 15px;
    padding: 15px;
    background-color: var(--light-bg);
    border-radius: 6px;
    border-left: 4px solid var(--primary-color);
}

.increment-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    cursor: pointer;
}

.increment-toggle input[type="checkbox"] {
    width: 16px;
    height: 16px;
}

.increment-toggle label {
    margin-bottom: 0;
    font-weight: 600;
    color: var(--secondary-color);
    cursor: pointer;
}

.increment-fields {
    display: none;
    gap: 15px;
    flex-wrap: wrap;
}

.increment-fields.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.increment-field {
    flex: 1;
    min-width: 150px;
}

.increment-field.full-width {
    flex: 0 0 100%;
}

.increment-field label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    font-size: 0.9rem;
}

.increment-amount-input,
.increment-frequency-select,
.increment-date-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border-color);
    border-radius: 5px;
    font-size: 0.9rem;
}

.increment-preview {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: white;
    border-radius: 4px;
    border: 1px solid var(--border-color);
    font-size: 0.85rem;
    color: var(--text-color);
}

.increment-preview .next-increment {
    color: var(--primary-color);
    font-weight: 600;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Export/Import Styles */
.export-import-section {
    margin-top: 30px;
    padding: 20px;
    background-color: var(--light-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.export-import-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}

.export-btn, .import-btn {
    background-color: var(--secondary-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.3s ease;
}

.export-btn:hover, .import-btn:hover {
    background-color: #1a252f;
}

.file-input {
    display: none;
}

/* Amount styling */
.debt-amount {
    font-size: 1.5rem;
    font-weight: bold;
    transition: color 0.3s ease;
}

/* Card layout improvements */
.debt-card {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: var(--shadow);
    transition: transform 0.3s ease;
    min-height: 100px;
}

.debt-content {
    flex: 1;
    margin-right: 15px;
    min-width: 0;
}

.debt-meta-info {
    margin-top: 8px;
    font-size: 0.8rem;
    color: var(--text-light);
}

.increment-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background-color: rgba(46, 204, 113, 0.1);
    color: var(--success-color);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-top: 4px;
}

</style>


</head>
<body>
    <div class="container">
        <header>
            <h1>Debt Dashboard</h1>
            <div class="total-debt">Total: ¬£0.00</div>
        </header>
        
        <div class="dashboard" id="debtDashboard">
            <!-- Debt cards will be dynamically added here -->
        </div>

        <div class="refresh-info" id="refreshInfo" style="display: none;">
            Last refreshed: <span id="lastRefreshTime">Never</span><br>
            Next refresh: <span id="nextRefreshTime">Calculating...</span>
        </div>
        
        <button class="settings-btn" id="settingsBtn">Settings</button>
        
        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Debt Settings</h2>
                    <button class="close-btn" id="closeModal">&times;</button>
                </div>
                
                <form id="debtForm">
                    <div class="form-group">
                        <label for="debtName">Debt Name</label>
                        <input type="text" id="debtName" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Data Source</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="autoSource" name="dataSource" value="auto" checked>
                                <label for="autoSource">Automated (Selenium)</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="manualSource" name="dataSource" value="manual">
                                <label for="manualSource">Manual Entry</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="autoFields">
                        <div class="form-group">
                            <label for="loginUrl">Login URL</label>
                            <input type="text" id="loginUrl">
                        </div>
                        
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" id="username">
                        </div>
                        
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password">
                        </div>
                    </div>
                    
                    <div class="form-group manual-amount" id="manualFields">
                        <label for="amount">Amount (¬£)</label>
                        <input type="number" id="amount" step="0.01" class="no-spinner">
                    </div>

                    <div class="form-group">
                         <label for="directLink">Direct Link</label>
                         <input type="text" id="directLink" placeholder="https://...">
                            <small style="color: var(--text-light); font-size: 0.8rem;">
                             If provided, the debt card will be clickable and open this link
                            </small>
                    </div>

                    
                    <div class="form-group">
                          <label for="notes">Notes</label>
                            <textarea id="notes" rows="3" placeholder="Add any notes about this debt..."></textarea>
                     </div>

                    <div class="form-group">
                        <label for="cardColor">Card Color</label>
                         <input type="color" id="cardColor" value="#ffffff">
                    </div>

                    <div class="form-group">
                        <label for="titleColor">Title Color</label>
                        <input type="color" id="titleColor" value="#2c3e50">
                    </div>

                    <div class="form-group">
                        <label for="logoImage">Logo Image</label>
                        <input type="file" id="logoImage" accept="image/*">
                         <small style="color: var(--text-light); font-size: 0.8rem;">
                              Select a square image from your local machine
                         </small>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Debt</button>
                    </div>
                </form>
                
                <div class="debt-list" id="debtList">
                    <!-- Existing debts will be listed here -->
                </div>


                           <!-- Add this Export/Import section to your settings modal -->
                <div class="export-import-section">
                    <h3>Data Management</h3>
                     <p>Export your data to a JSON file for backup or transfer to another machine.</p>
                  <div class="export-import-buttons">
                    <button class="export-btn" id="exportBtn">Export to JSON</button>
                    <button class="import-btn" id="importBtn">Import from JSON</button>
                     <input type="file" id="importFile" class="file-input" accept=".json">
                  </div>
                    <small style="color: var(--text-light);">
                     Exported file includes all debt data, logos (as base64), and settings.
                    </small>
                </div>


            </div>
        </div>
    </div>

    
<script>
    // Debt Dashboard Application
let debts = [];
let logoFile = null;

// DOM Elements
const debtDashboard = document.getElementById('debtDashboard');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeModal = document.getElementById('closeModal');
const cancelBtn = document.getElementById('cancelBtn');
const debtForm = document.getElementById('debtForm');
const debtList = document.getElementById('debtList');
const autoSource = document.getElementById('autoSource');
const manualSource = document.getElementById('manualSource');
const autoFields = document.getElementById('autoFields');
const manualFields = document.getElementById('manualFields');
const totalDebtElement = document.querySelector('.total-debt');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');

// Initialize the dashboard
function initDashboard() {
    loadDataFromJSON(); // Try to load from JSON first
    if (debts.length === 0) {
        debts = loadDebtsFromLocalStorage(); // Fallback to localStorage
    }
    renderDebtCards();
    updateTotalDebt();
    renderDebtList();
    processRegularIncrements();
    startAutoRefresh();
}

// Load data from JSON file (primary storage)
async function loadDataFromJSON() {
    try {
        const response = await fetch('debts.json');
        if (response.ok) {
            const data = await response.json();
            if (data && Array.isArray(data.debts)) {
                debts = data.debts;
                console.log('Data loaded from JSON file');
                return true;
            }
        }
    } catch (error) {
        console.log('No JSON file found, using localStorage');
    }
    return false;
}

// Save data to JSON file
async function saveDataToJSON() {
    const data = {
        debts: debts,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'debts_export.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Import data from JSON file
function importDataFromJSON(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if (data && Array.isArray(data.debts)) {
                debts = data.debts;
                saveDebtsToLocalStorage();
                renderDebtCards();
                updateTotalDebt();
                renderDebtList();
                showRefreshNotification('Data imported successfully!');
            } else {
                alert('Invalid JSON file format');
            }
        } catch (error) {
            alert('Error reading JSON file: ' + error.message);
        }
    };
    reader.readAsText(file);
}

// Render debt cards
function renderDebtCards() {
    debtDashboard.innerHTML = '';
    
    debts.forEach(debt => {
        const debtCard = document.createElement('div');
        debtCard.className = 'debt-card';
        
        let incrementInfo = '';
        if (debt.regularIncrement && debt.regularIncrement.enabled) {
            const nextIncrement = calculateNextIncrement(debt);
            incrementInfo = `
                <div class="increment-indicator">
                    ‚ÜóÔ∏è +¬£${debt.regularIncrement.amount} ${debt.regularIncrement.frequency}
                    ${nextIncrement ? `¬∑ Next: ${nextIncrement}` : ''}
                </div>
            `;
        }
        
        debtCard.innerHTML = `
            <div class="debt-content">
                <div class="debt-title">
                    <div class="debt-name ${debt.direct_link ? 'clickable' : ''}" style="color: ${debt.titleColor || 'var(--secondary-color)'}">${debt.name}</div>
                    ${debt.notes ? `<span class="info-icon" data-id="${debt.id}">‚ÑπÔ∏è</span>` : ''}
                </div>
                <div class="debt-amount" style="color: ${debt.titleColor || 'var(--danger-color)'}">¬£${debt.amount.toFixed(2)}</div>
                ${incrementInfo}
                ${debt.notes ? `<div class="debt-meta-info">${debt.notes.substring(0, 50)}${debt.notes.length > 50 ? '...' : ''}</div>` : ''}
            </div>
            ${debt.logoImage ? `<img src="${debt.logoImage}" alt="${debt.name} logo" class="debt-logo">` : ''}
        `;

        if (debt.cardColor && debt.cardColor !== '#ffffff') {
            debtCard.style.backgroundColor = debt.cardColor;
        }

        if (debt.direct_link) {
            const debtName = debtCard.querySelector('.debt-name.clickable');
            debtName.addEventListener('click', (e) => {
                e.stopPropagation();
                window.open(debt.direct_link, '_blank');
            });
        }

        debtDashboard.appendChild(debtCard);
    });
    
    document.querySelectorAll('.info-icon').forEach(icon => {
        icon.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = parseInt(icon.getAttribute('data-id'));
            showNotesPopup(id);
        });
    });
}

// Update total debt display
function updateTotalDebt() {
    const total = debts.reduce((sum, debt) => sum + debt.amount, 0);
    totalDebtElement.textContent = `Total: ¬£${total.toFixed(2)}`;
}

// Update debt amount
function updateDebtAmount(id, newAmount) {
    const debt = debts.find(d => d.id === id);
    if (debt) {
        debt.amount = newAmount;
        saveDebtsToLocalStorage();
        renderDebtCards();
        updateTotalDebt();
        showRefreshNotification(`Updated ${debt.name} to ¬£${newAmount.toFixed(2)}`);
    }
}

// Render debt list in settings
function renderDebtList() {
    debtList.innerHTML = '';
    
    if (debts.length === 0) {
        debtList.innerHTML = '<p>No debts configured yet.</p>';
        return;
    }
    
    debts.forEach(debt => {
        const debtItem = document.createElement('div');
        debtItem.className = 'debt-item';
        
        const hasIncrement = debt.regularIncrement && debt.regularIncrement.enabled;
        const incrementFieldsDisplay = hasIncrement ? 'flex' : 'none';
        const incrementChecked = hasIncrement ? 'checked' : '';
        const startDate = debt.regularIncrement?.startDate || new Date().toISOString().split('T')[0];
        
        debtItem.innerHTML = `
            <div class="debt-display">
                <div class="debt-info">
                    <strong>${debt.name}</strong>
                    <div class="debt-amount-controls">
                        <span class="amount-label">Amount: ¬£</span>
                        <input type="number" class="amount-input" value="${debt.amount.toFixed(2)}" step="0.01" data-id="${debt.id}">
                        <button class="icon-btn update-btn" data-id="${debt.id}" title="Update Amount">üîÑ</button>
                    </div>
                    <div class="debt-meta">
                        <span class="debt-source">${debt.source === 'manual' ? 'Manual' : 'Automated'}</span>
                        ${debt.source === 'auto' ? `<span class="debt-url">${debt.login_url || 'No URL'}</span>` : ''}
                        ${hasIncrement ? `<span class="increment-indicator" style="margin: 0;">+¬£${debt.regularIncrement.amount} ${debt.regularIncrement.frequency}</span>` : ''}
                    </div>
                </div>
                <div class="debt-actions">
                    <button class="icon-btn edit-btn-icon" data-id="${debt.id}" title="Edit Debt">‚úèÔ∏è</button>
                    <button class="icon-btn delete-btn-icon" data-id="${debt.id}" title="Delete Debt">üóëÔ∏è</button>
                </div>
            </div>
            <div class="debt-edit-form" id="edit-form-${debt.id}" style="display: none;">
                <div class="edit-form-content">
                    <h4>Edit ${debt.name}</h4>
                    <form class="edit-debt-form" data-id="${debt.id}">
                        <!-- Existing form fields remain the same -->
                        <div class="form-group">
                            <label for="edit-name-${debt.id}">Debt Name</label>
                            <input type="text" id="edit-name-${debt.id}" value="${debt.name}" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Data Source</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="edit-auto-${debt.id}" name="edit-dataSource-${debt.id}" value="auto" ${debt.source === 'auto' ? 'checked' : ''}>
                                    <label for="edit-auto-${debt.id}">Automated (Selenium)</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="edit-manual-${debt.id}" name="edit-dataSource-${debt.id}" value="manual" ${debt.source === 'manual' ? 'checked' : ''}>
                                    <label for="edit-manual-${debt.id}">Manual Entry</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="edit-auto-fields" id="edit-auto-fields-${debt.id}" style="${debt.source === 'auto' ? '' : 'display: none;'}">
                            <div class="form-group">
                                <label for="edit-loginUrl-${debt.id}">Login URL</label>
                                <input type="text" id="edit-loginUrl-${debt.id}" value="${debt.login_url || ''}">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-username-${debt.id}">Username</label>
                                <input type="text" id="edit-username-${debt.id}" value="${debt.username || ''}">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-password-${debt.id}">Password</label>
                                <input type="password" id="edit-password-${debt.id}" value="" placeholder="Enter new password">
                            </div>
                        </div>
                        
                        <div class="form-group edit-manual-amount" id="edit-manual-fields-${debt.id}" style="${debt.source === 'manual' ? '' : 'display: none;'}">
                            <label for="edit-amount-${debt.id}">Amount (¬£)</label>
                            <input type="number" id="edit-amount-${debt.id}" value="${debt.amount}" step="0.01" class="no-spinner">
                        </div>

                        <div class="form-group">
                            <label for="edit-directLink-${debt.id}">Direct Link</label>
                            <input type="text" id="edit-directLink-${debt.id}" value="${debt.direct_link || ''}" placeholder="https://...">
                        </div>

                        <div class="form-group">
                            <label for="edit-notes-${debt.id}">Notes</label>
                            <textarea id="edit-notes-${debt.id}" rows="3">${debt.notes || ''}</textarea>
                        </div>

                        <div class="form-group">
                            <label for="edit-cardColor-${debt.id}">Card Color</label>
                            <input type="color" id="edit-cardColor-${debt.id}" value="${debt.cardColor || '#ffffff'}">
                        </div>

                        <div class="form-group">
                            <label for="edit-titleColor-${debt.id}">Title Color</label>
                            <input type="color" id="edit-titleColor-${debt.id}" value="${debt.titleColor || '#2c3e50'}">
                        </div>

                        <div class="form-group">
                            <label for="edit-logoImage-${debt.id}">Logo Image</label>
                            <input type="file" id="edit-logoImage-${debt.id}" accept="image/*">
                            ${debt.logoImage ? '<small style="color: var(--success-color);">Current image loaded</small>' : ''}
                        </div>

                        <!-- Updated Regular Increment Section -->
                        <div class="regular-increment-section">
                            <div class="increment-toggle">
                                <input type="checkbox" id="edit-regularIncrement-${debt.id}" ${incrementChecked}>
                                <label for="edit-regularIncrement-${debt.id}">Enable Regular Amount Increment</label>
                            </div>
                            <div class="increment-fields ${hasIncrement ? 'active' : ''}" id="edit-increment-fields-${debt.id}">
                                <div class="increment-field">
                                    <label for="edit-incrementAmount-${debt.id}">Increment Amount (¬£)</label>
                                    <input type="number" id="edit-incrementAmount-${debt.id}" class="increment-amount-input" value="${hasIncrement ? debt.regularIncrement.amount : '0'}" step="0.01" min="0">
                                </div>
                                <div class="increment-field">
                                    <label for="edit-incrementFrequency-${debt.id}">Frequency</label>
                                    <select id="edit-incrementFrequency-${debt.id}" class="increment-frequency-select">
                                        <option value="weekly" ${hasIncrement && debt.regularIncrement.frequency === 'weekly' ? 'selected' : ''}>Weekly</option>
                                        <option value="fortnightly" ${hasIncrement && debt.regularIncrement.frequency === 'fortnightly' ? 'selected' : ''}>Fortnightly</option>
                                        <option value="triweekly" ${hasIncrement && debt.regularIncrement.frequency === 'triweekly' ? 'selected' : ''}>Tri-weekly</option>
                                        <option value="monthly" ${hasIncrement && debt.regularIncrement.frequency === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    </select>
                                </div>
                                <div class="increment-field full-width">
                                    <label for="edit-incrementStartDate-${debt.id}">Start Date</label>
                                    <input type="date" id="edit-incrementStartDate-${debt.id}" class="increment-date-input" value="${startDate}">
                                </div>
                            </div>
                            ${hasIncrement ? `
                                <div class="increment-preview">
                                    Next increment: <span class="next-increment">${calculateNextIncrement(debt)}</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary cancel-edit-btn" data-id="${debt.id}">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        debtList.appendChild(debtItem);
    });
    
    // Add event listeners
    document.querySelectorAll('.update-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const input = document.querySelector(`.amount-input[data-id="${id}"]`);
            const newAmount = parseFloat(input.value) || 0;
            updateDebtAmount(id, newAmount);
        });
    });
    
    document.querySelectorAll('.edit-btn-icon').forEach(button => {
        button.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            toggleEditForm(id);
        });
    });
    
    document.querySelectorAll('.cancel-edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            toggleEditForm(id, false);
        });
    });
    
    document.querySelectorAll('.edit-debt-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const id = parseInt(this.getAttribute('data-id'));
            saveDebtChanges(id);
        });
    });
    
    document.querySelectorAll('input[name^="edit-dataSource-"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const id = this.id.split('-')[2];
            toggleEditDataSource(id);
        });
    });
    
    document.querySelectorAll('.delete-btn-icon').forEach(button => {
        button.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            deleteDebt(id);
        });
    });
    
    // Fix: Add immediate toggle for increment fields
    document.querySelectorAll('.increment-toggle input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const id = this.id.split('-')[3];
            const incrementFields = document.getElementById(`edit-increment-fields-${id}`);
            if (this.checked) {
                incrementFields.classList.add('active');
            } else {
                incrementFields.classList.remove('active');
            }
        });
    });
}

// Calculate next increment date
function calculateNextIncrement(debt) {
    if (!debt.regularIncrement || !debt.regularIncrement.enabled) return null;
    
    const startDate = new Date(debt.regularIncrement.startDate || debt.regularIncrement.lastIncrement || new Date());
    const now = new Date();
    let nextDate = new Date(startDate);
    
    while (nextDate <= now) {
        switch (debt.regularIncrement.frequency) {
            case 'weekly':
                nextDate.setDate(nextDate.getDate() + 7);
                break;
            case 'fortnightly':
                nextDate.setDate(nextDate.getDate() + 14);
                break;
            case 'triweekly':
                nextDate.setDate(nextDate.getDate() + 21);
                break;
            case 'monthly':
                nextDate.setMonth(nextDate.getMonth() + 1);
                break;
        }
    }
    
    return nextDate.toLocaleDateString();
}

// Process regular increments
function processRegularIncrements() {
    const now = new Date();
    let updated = false;
    
    debts.forEach(debt => {
        if (debt.regularIncrement && debt.regularIncrement.enabled) {
            const startDate = new Date(debt.regularIncrement.startDate || debt.regularIncrement.lastIncrement || new Date());
            let nextIncrement = new Date(startDate);
            
            // Find the next increment date that hasn't passed yet
            while (nextIncrement <= now) {
                // Apply the increment
                debt.amount += debt.regularIncrement.amount;
                debt.regularIncrement.lastIncrement = nextIncrement.toISOString();
                
                // Calculate next increment
                switch (debt.regularIncrement.frequency) {
                    case 'weekly':
                        nextIncrement.setDate(nextIncrement.getDate() + 7);
                        break;
                    case 'fortnightly':
                        nextIncrement.setDate(nextIncrement.getDate() + 14);
                        break;
                    case 'triweekly':
                        nextIncrement.setDate(nextIncrement.getDate() + 21);
                        break;
                    case 'monthly':
                        nextIncrement.setMonth(nextIncrement.getMonth() + 1);
                        break;
                }
                updated = true;
            }
        }
    });
    
    if (updated) {
        saveDebtsToLocalStorage();
        renderDebtCards();
        updateTotalDebt();
    }
}

// Save debt changes
function saveDebtChanges(id) {
    const debt = debts.find(d => d.id === id);
    if (!debt) return;
    
    const newName = document.getElementById(`edit-name-${id}`).value;
    const newDataSource = document.querySelector(`input[name="edit-dataSource-${id}"]:checked`).value;
    const newAmount = parseFloat(document.getElementById(`edit-amount-${id}`).value) || 0;
    const newNotes = document.getElementById(`edit-notes-${id}`).value;
    const newDirectLink = document.getElementById(`edit-directLink-${id}`).value;
    const logoFile = document.getElementById(`edit-logoImage-${id}`).files[0];
    const regularIncrementEnabled = document.getElementById(`edit-regularIncrement-${id}`).checked;
    const incrementAmount = parseFloat(document.getElementById(`edit-incrementAmount-${id}`).value) || 0;
    const incrementFrequency = document.getElementById(`edit-incrementFrequency-${id}`).value;
    const incrementStartDate = document.getElementById(`edit-incrementStartDate-${id}`).value;
    
    debt.name = newName;
    debt.source = newDataSource;
    debt.amount = newAmount;
    debt.notes = newNotes;
    debt.direct_link = newDirectLink;
    debt.cardColor = document.getElementById(`edit-cardColor-${id}`).value;
    debt.titleColor = document.getElementById(`edit-titleColor-${id}`).value;
    
    debt.regularIncrement = {
        enabled: regularIncrementEnabled,
        amount: incrementAmount,
        frequency: incrementFrequency,
        startDate: incrementStartDate,
        lastIncrement: debt.regularIncrement?.lastIncrement || null
    };
    
    if (logoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            debt.logoImage = e.target.result;
            completeSaveDebtChanges(debt, newDataSource, id);
        };
        reader.readAsDataURL(logoFile);
    } else {
        completeSaveDebtChanges(debt, newDataSource, id);
    }
}

function completeSaveDebtChanges(debt, newDataSource, id) {
    if (newDataSource === 'auto') {
        debt.login_url = document.getElementById(`edit-loginUrl-${id}`).value;
        debt.username = document.getElementById(`edit-username-${id}`).value;
        const newPassword = document.getElementById(`edit-password-${id}`).value;
        if (newPassword) {
            debt.password = newPassword;
        }
    } else {
        debt.login_url = '';
        debt.username = '';
        debt.password = '';
    }
    
    saveDebtsToLocalStorage();
    renderDebtCards();
    updateTotalDebt();
    renderDebtList();
    showRefreshNotification(`Updated ${debt.name} successfully`);
}

// Save to localStorage (secondary)
function saveDebtsToLocalStorage() {
    localStorage.setItem('debtDashboard', JSON.stringify(debts));
}

// Load from localStorage (fallback)
function loadDebtsFromLocalStorage() {
    const saved = localStorage.getItem('debtDashboard');
    if (saved) {
        return JSON.parse(saved);
    }
    return [
        { 
            id: 1, 
            name: "Octopus Energy", 
            amount: 1000.00, 
            source: "manual", 
            notes: "Monthly: ¬£75", 
            direct_link: "https://example.com", 
            cardColor: "#ffffff", 
            titleColor: "#2c3e50", 
            logoImage: "",
            regularIncrement: {
                enabled: false,
                amount: 0,
                frequency: 'weekly',
                startDate: new Date().toISOString().split('T')[0],
                lastIncrement: null
            }
        }
    ];
}

// Delete debt
function deleteDebt(id) {
    if (confirm('Are you sure you want to delete this debt?')) {
        debts = debts.filter(debt => debt.id !== id);
        saveDebtsToLocalStorage();
        renderDebtCards();
        updateTotalDebt();
        renderDebtList();
    }
}

// Show notes popup (keep existing implementation)
function showNotesPopup(id) {
    // ... keep your existing showNotesPopup function
}

// Toggle data source (keep existing implementation)
function toggleDataSource() {
    // ... keep your existing toggleDataSource function
}

// Add new debt (keep existing implementation)
function addDebt(event) {
    // ... keep your existing addDebt function, but ensure it includes:
    // regularIncrement: { enabled: false, amount: 0, frequency: 'weekly', startDate: new Date().toISOString().split('T')[0], lastIncrement: null }
}

// Reset form (keep existing implementation)
function resetForm() {
    // ... keep your existing resetForm function
}

// Toggle edit form (keep existing implementation)
function toggleEditForm(id, show = true) {
    // ... keep your existing toggleEditForm function
}

// Toggle edit data source (keep existing implementation)
function toggleEditDataSource(id) {
    // ... keep your existing toggleEditDataSource function
}

// Show refresh notification (keep existing implementation)
function showRefreshNotification(message) {
    // ... keep your existing showRefreshNotification function
}

// Auto-refresh functionality (keep existing implementation)
function startAutoRefresh() {
    // ... keep your existing startAutoRefresh function
}

// Event Listeners
settingsBtn.addEventListener('click', () => {
    settingsModal.style.display = 'flex';
});

closeModal.addEventListener('click', () => {
    settingsModal.style.display = 'none';
});

cancelBtn.addEventListener('click', () => {
    settingsModal.style.display = 'none';
});

debtForm.addEventListener('submit', addDebt);

autoSource.addEventListener('change', toggleDataSource);
manualSource.addEventListener('change', toggleDataSource);

// Export/Import event listeners
exportBtn.addEventListener('click', saveDataToJSON);
importBtn.addEventListener('click', () => importFile.click());
importFile.addEventListener('change', (e) => {
    if (e.target.files[0]) {
        importDataFromJSON(e.target.files[0]);
        e.target.value = ''; // Reset file input
    }
});

window.addEventListener('click', (event) => {
    if (event.target === settingsModal) {
        settingsModal.style.display = 'none';
    }
});

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', initDashboard);

// Process increments every hour
setInterval(processRegularIncrements, 60 * 60 * 1000);
</script>

</body>
</html>
